<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1086465/"> 1086465</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/2cc5d9fe3d6b437d75136cbab1a09124e1e0e5ca">2cc5d9fe3d6b437d75136cbab1a09124e1e0e5ca</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1086534/">1086534</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/935279a833f38a03097a8ee005ee175bf48c2e58">935279a833f38a03097a8ee005ee175bf48c2e58</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   2cc5d9fe3d6b437d75136cbab1a09124e1e0e5ca
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/2cc5d9fe3d6b437d75136cbab1a09124e1e0e5ca">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/2cc5d9fe3d6b437d75136cbab1a09124e1e0e5ca.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Matt Wolenetz &lt;wolenetz@chromium.org&gt;
  </td>
  <td>
   Thu Dec 22 19:07:44 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Thu Dec 22 19:07:44 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/2cc5d9fe3d6b437d75136cbab1a09124e1e0e5ca/">
    f0b6e5c1b13242664d64f2bc375fbb6f10af3820
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/2cc5d9fe3d6b437d75136cbab1a09124e1e0e5ca%5E">
    e3cbf6f34347be7936a822c26a00c3b1a6d2edbf
   </a>
   <span>
    [
    <a href="/chromium/src/+/2cc5d9fe3d6b437d75136cbab1a09124e1e0e5ca%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">[MSE] Let AppendToParseBuffer fail if StreamParser's allocation/copy fails

Lets the synchronous "PrepareAppend" portion of
SourceBuffer.appendBuffer() gracefully throw exception if the initial
memory allocation fails. Previous CL [1] that removed an extra
allocation and copy also removed detection of allocation failure for
that extra copy, but did not fully enable graceful failure if allocation
of space for the optimized copy of the appended bytes within
AppendToParseBuffer() failed.

Also fixes an error introduced in that previous CL that would have
fatally failed the MediaElement if AppendToParseBuffer failed; the app
is instead allowed to actually get a QuotaExceeded error and retry when
the underlying AppendToParseBuffer failed. That error was introduced
when ChunkDemuxer::AppendData had been renamed to RunSegmentParserLoop
and a preliminary AppendToParseBuffer method was pasted with incorrect
append failure logic. Note that RunSegmentParserLoop() still correctly
fatally fails the media element if the actual parse of previously
appended data fails.

During mp2t_stream_parser's flush of internal es_parser_h264, there's a
pre-existing push of delimiter bytes required to emit potentially
complete data from parse during that flush. That flush does not occur
during AppendToParseBuffer, so there is a CHECK now to retain previous
behavior if the delimiter bytes' push fails. Likewise, the ByteQueue
constructor requires the initial backing `buffer_` be successfully
allocated, and since that `buffer_` now is managed with
UncheckedMalloc/UncheckedFree, the constructor contains a CHECK that the
initial allocation succeeds. AppendToParseBuffer does not construct
ByteQueue; it just pushes to one that is already constructed, so the
CHECK doesn't conflict with the intent of this change.

Finally, also note that the various TsSection parsers within the
mp2t_stream_parser have ByteQueues that are pushed to during the Parse
phase of the StreamParser (as noted already, there's a Flush edge case
for es_parser_h264) and can now indicate parse failure to app for many
of those pushes that would previously have failed due to OOM. Hence,
this change may cause MSE parse error (decode error) increase on
memory-constrained platforms with builds where enable_mse_mpeg2ts_stream_parser is true, but OOM may similarly drop
there.

[1] <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3362558">https://chromium-review.googlesource.com/c/chromium/src/+/3362558</a>

Bug: 1395788,1286810,1266639
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/Iab324bf8d2a17369747ffb5fa8f33a5dded84cc1">Iab324bf8d2a17369747ffb5fa8f33a5dded84cc1</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/4112664">https://chromium-review.googlesource.com/c/chromium/src/+/4112664</a>
Reviewed-by: Will Cassella &lt;cassew@chromium.org&gt;
Commit-Queue: Matthew Wolenetz &lt;wolenetz@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1086465}
</pre>

</body>
</html>
