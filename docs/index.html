<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/837797/"> 837797</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/95f64623df8e0526f3ae68ef664798c4a4a733f7">95f64623df8e0526f3ae68ef664798c4a4a733f7</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/837767/">837767</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/94141dd63cf491cfe7ebdb90524cf2725881950f">94141dd63cf491cfe7ebdb90524cf2725881950f</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   95f64623df8e0526f3ae68ef664798c4a4a733f7
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/95f64623df8e0526f3ae68ef664798c4a4a733f7">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/95f64623df8e0526f3ae68ef664798c4a4a733f7.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Xiaohan Wang &lt;xhwang@chromium.org&gt;
  </td>
  <td>
   Wed Dec 16 23:09:39 2020
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Wed Dec 16 23:09:39 2020
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/95f64623df8e0526f3ae68ef664798c4a4a733f7/">
    9842a2a2610a337e798155c0d2f60ad2f9251ce4
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/95f64623df8e0526f3ae68ef664798c4a4a733f7%5E">
    827096af4a21dc98e216199b0286de9f31a2cc9f
   </a>
   <span>
    [
    <a href="/chromium/src/+/95f64623df8e0526f3ae68ef664798c4a4a733f7%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">Report permission UKM for PERMISSION_PROTECTED_MEDIA_IDENTIFIER

This was in the original design but missed in the implementation because
ProtectedMediaIdentifierPermissionContext uses a custom permission
prompt logic.

This CL updates ProtectedMediaIdentifierPermissionContext to report the
UKM. We are also able to remove our own ReportPermissionActionUMA()
since that's covered automatically by the new approach.

In the future, when we use standard permission bubbles for
ProtectedMediaIdentifierPermissionContext we won't need this anymore.

Manually tested:
0. Hacked media/blink/key_system_config_selector.cc to always request
   permission.
1. Build ChromeOS Chrome on Linux.
2. Start Chrome with the following flags:
   --force-enable-metrics-reporting --metrics-upload-interval=1
3. Play protected content on Shaka Player, and saw the prompt.
4. Go to chrome://ukm and chrome://histograms to check results.
   See below.

Without this change:

Histogram: Permissions.Action.ProtectedMedia recorded 1 samples, mean = 2.0 (flags = 0x41)
0  ...
2  ------------------------------------------------------------------------O (1 = 100.0%) {0.0%}
3  ...

With this change:

Permission
Action	1
Gesture	2
PermissionType	21
PriorDismissals	0
PriorIgnores	0
PromptDisposition	0
Source	0

Histogram: Permissions.Action.ProtectedMedia recorded 2 samples, mean = 0.5 (flags = 0x41)
0  ------------------------------------------------------------------------O (1 = 50.0%)
1  ------------------------------------------------------------------------O (1 = 50.0%) {50.0%}
2  ...

Bug: 1158868
Test: See above
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/Ie852f26550e0f403806e70fb50f4c8897e7e5c11">Ie852f26550e0f403806e70fb50f4c8897e7e5c11</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/2594120">https://chromium-review.googlesource.com/c/chromium/src/+/2594120</a>
Auto-Submit: Xiaohan Wang &lt;xhwang@chromium.org&gt;
Reviewed-by: Weilun Shi &lt;sweilun@chromium.org&gt;
Reviewed-by: Ilya Sherman &lt;isherman@chromium.org&gt;
Reviewed-by: John Rummell &lt;jrummell@chromium.org&gt;
Reviewed-by: Balazs Engedy &lt;engedy@chromium.org&gt;
Commit-Queue: Xiaohan Wang &lt;xhwang@chromium.org&gt;
Cr-Commit-Position: refs/heads/master@{#837797}
</pre>

</body>
</html>
