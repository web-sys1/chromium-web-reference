<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/923804/"> 923804</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/0e3a8b1a3ef29e035034e1f3c8078effd87cc985">0e3a8b1a3ef29e035034e1f3c8078effd87cc985</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/923799/">923799</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/39aaced78bfbbf6607c2dd241cdaa107bc9474e6">39aaced78bfbbf6607c2dd241cdaa107bc9474e6</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   0e3a8b1a3ef29e035034e1f3c8078effd87cc985
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/0e3a8b1a3ef29e035034e1f3c8078effd87cc985">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/0e3a8b1a3ef29e035034e1f3c8078effd87cc985.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Benoit Lize &lt;lizeb@chromium.org&gt;
  </td>
  <td>
   Wed Sep 22 11:00:42 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Wed Sep 22 11:00:42 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/0e3a8b1a3ef29e035034e1f3c8078effd87cc985/">
    d40075768b50bde89e380df5db6a38e1bb121da3
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/0e3a8b1a3ef29e035034e1f3c8078effd87cc985%5E">
    a709490e8df9fa364cb114d2fc17a0727687cd29
   </a>
   <span>
    [
    <a href="/chromium/src/+/0e3a8b1a3ef29e035034e1f3c8078effd87cc985%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">[PartitionAlloc] Speed up root fetch in Free().

For each `free(ptr)`, we need to fetch the PartitionRoot matching
`ptr`. This is currently done from the `slot_span`, introducing a
critical path ptr -&gt; slot_span -&gt; root to proceed.

However, there is no need to do it this way, as the root can be obtained
from the pointer directly. This changes the critical path into two
parallel ones:
1. ptr -&gt; slot_span
2. ptr -&gt; root

This is important, as getting to the SlotSpan is a slow operation
(looking into the metadata area, and following a pointer), and SlotSpans
can induce cache coherency traffic (since they're read on every free(),
and written to on any malloc()/free() that is not a hit in the thread
cache).

From in-the-wild profiling, getting the slot span and the root are the
two most expensive operations in Free(), by far.

Below is edited output from Chrome OS-wide profiling:

      shrq	$0x9, %rax              PartitionPage::FromPtr
      andq	$-0x200000, %rbx        PartitionPage::FromPtr
      andl	$0xfe0, %eax            PartitionPage::FromPtr
      leaq	0x1000(%rbx,%rax), %r9  PartitionPage::FromPtr
(a)   movzbl	0x101e(%rbx,%rax), %eax SlotSpanMetadata::FromSlotInnerPtr
      movq	%r9, %rsi               SlotSpanMetadata::FromSlotInnerPtr
      movq	%rax, %rcx              SlotSpanMetadata::FromSlotInnerPtr
      shlq	$0x5, %rax              SlotSpanMetadata::FromSlotInnerPtr
      subq	%rax, %rsi              SlotSpanMetadata::FromSlotInnerPtr
      negq	%rcx                    SlotSpanMetadata::FromSlotInnerPtr
      movq	%rsi, %rax              PartitionRoot::FromSlotSpan
      prefetcht0	(%rsi)          PartitionRoot::FreeNoHooks
      andq	$-0x1000, %rax          PartitionRoot::FromSlotSpan
(b)   movq	(%rax), %rdi            PartitionRoot::FromSlotSpan

Line (a) is responsible for 32% of samples, and (b) for 13%.
In other in-the-wild profiling, line (a) is 24% and (b) ~9%.

This shows how expensive these operations are. Breaking the dependency
between them should improve performance.

There, %rax contains the address of the SlotSpanMetadata, and in the
line before (b), it is masked to get to the start of its page, then the
root is fetched. So it is necessarily blocked behind computing the
SlotSpanMetadata address.

Generated code after (Linux, x86_64, release build):

     &lt;+29&gt;:    prefetcht0 (%rsi)
     &lt;+32&gt;:    mov    %rsi,%rbx
     &lt;+35&gt;:    and    $0xffffffffffe00000,%rbx
(b)  &lt;+42&gt;:    mov    0x1000(%rbx),%r15
     &lt;+49&gt;:    mov    %rsi,%r14
     &lt;+52&gt;:    shr    $0x9,%r14
     &lt;+56&gt;:    mov    %r14d,%eax
     &lt;+59&gt;:    and    $0xfe0,%eax
     &lt;+64&gt;:    lea    (%rbx,%rax,1),%r8
     &lt;+68&gt;:    add    $0x1000,%r8
(a)  &lt;+75&gt;:    movzbl 0x101e(%rbx,%rax,1),%eax
     &lt;+83&gt;:    mov    %rax,%r13
     &lt;+86&gt;:    neg    %r13
     &lt;+89&gt;:    shl    $0x5,%rax
     &lt;+93&gt;:    mov    %r8,%rcx
     &lt;+96&gt;:    sub    %rax,%rcx
     &lt;+99&gt;:    mov    %rcx,-0x30(%rbp)
     &lt;+103&gt;:   prefetcht0 (%rcx)
     &lt;+106&gt;:   cmpb   $0x2,(%r15)
     &lt;+110&gt;:   je     0x11db26f &lt;PartitionFree()+479&gt;
     &lt;+116&gt;:   cmpb   $0x0,0x2(%r15)

Where (b) is equivalent to the (b) line above, and there is no
dependency anymore.

Bug: 1207307
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/Iec426cfde69d3ce30f25c0f6693aff0331f517fe">Iec426cfde69d3ce30f25c0f6693aff0331f517fe</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3173131">https://chromium-review.googlesource.com/c/chromium/src/+/3173131</a>
Commit-Queue: Benoit L &lt;lizeb@chromium.org&gt;
Reviewed-by: Anton Bikineev &lt;bikineev@chromium.org&gt;
Reviewed-by: Bartek Nowierski &lt;bartekn@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#923804}
</pre>

</body>
</html>
