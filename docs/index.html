<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1242371/"> 1242371</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/c9c6c875f6b8df9aeba5653c60571143e475ba08">c9c6c875f6b8df9aeba5653c60571143e475ba08</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1242360/">1242360</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/64d6c5d8cddd7e2ff7d088684c6f374609f6a85d">64d6c5d8cddd7e2ff7d088684c6f374609f6a85d</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   c9c6c875f6b8df9aeba5653c60571143e475ba08
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/c9c6c875f6b8df9aeba5653c60571143e475ba08">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/c9c6c875f6b8df9aeba5653c60571143e475ba08.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Steinar H. Gunderson &lt;sesse@chromium.org&gt;
  </td>
  <td>
   Wed Jan 03 12:13:08 2024
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Wed Jan 03 12:13:08 2024
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/c9c6c875f6b8df9aeba5653c60571143e475ba08/">
    2b6c8e722d3ad519e48c542229224e624314def6
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/c9c6c875f6b8df9aeba5653c60571143e475ba08%5E">
    1fda2df414430e9dacc8e19c9a9cc9040907f01a
   </a>
   <span>
    [
    <a href="/chromium/src/+/c9c6c875f6b8df9aeba5653c60571143e475ba08%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table>
<hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">When testing MPC hits for matching inherited data, compare by-value.

This makes for a more expensive comparison, but we get it back by
getting complete MPC hits more often -- saving both RAM and CPU.
(The effect is especially pronounced on style recalcs, where the
MPC already most likely contains nearly everything we'd want.)
In particular, if two elements get the same state from different
parts in the tree, the pointers are not the same, but the data
is equivalent. E.g.

  * div
    * div class="a"
      * span class="b"
    * div class="a"
      * span class="b"  &lt;-- would get a partial MPC hit before, full now

Note also that there is a knock-on effect from reusing the ComputedStyle
from the MPC hit, in that any similar children of the two spans would
now automatically have the same group pointers for inherited data,
too (so when we get a match, we don't need the by-value comparison for
all the children; the pointers will be the same and the comparison will
short-circuit).

This saves a large amount of ComputedStyle RAM:

  Video            766 →   395 kB ( -371 kB)
  Extension       3002 →  1670 kB (-1332 kB)
  News            1724 →  1442 kB ( -282 kB)
  ECommerce        238 →   198 kB (  -40 kB)
  Social1          755 →   588 kB ( -167 kB)
  Social2          536 →   461 kB (  -75 kB)
  Encyclopedia    1658 →  1293 kB ( -365 kB)
  Sports           541 →   409 kB ( -132 kB)
  Search           415 →   238 kB ( -177 kB)

It would be possible to force-rewrite equivalent pointers into
each other to save yet more RAM (one of them could be GC-ed away
even if we did not have an MPC match), but from a quick prototyping,
the effect is mostly small, and it costs a little more CPU (~1%).

It also saves CPU (style perftest, Zen 2, LTO but no PGO):

  Initial style (µs)     Before     After    Perf      95% CI (BCa)
  =================== ========= ========= ======= =================
  ECommerce                8456      8373   +1.0%  [ +0.4%,  +1.5%]
  Encyclopedia            71749     70657   +1.5%  [ +1.0%,  +2.4%]
  Extension               93541     86623   +8.0%  [ +7.2%,  +8.6%]
  News                    36167     35159   +2.9%  [ +2.4%,  +3.7%]
  Search                  10621     10295   +3.2%  [ +2.7%,  +3.7%]
  Social1                 20412     19897   +2.6%  [ +2.1%,  +3.1%]
  Social2                 13418     13165   +1.9%  [ +1.3%,  +2.6%]
  Sports                  39573     38658   +2.4%  [ +1.3%,  +6.3%]
  Video                   30046     27558   +9.0%  [ +8.5%,  +9.6%]
  Geometric mean                            +3.6%  [ +3.0%,  +4.1%]

  Recalc style (µs)      Before     After    Perf      95% CI (BCa)
  =================== ========= ========= ======= =================
  ECommerce                5267      4418  +19.2%  [+18.1%, +20.5%]
  Encyclopedia            59969     56885   +5.4%  [ +5.0%,  +6.3%]
  Extension               79453     70043  +13.4%  [+12.2%, +14.5%]
  News                    27126     22136  +22.5%  [+21.5%, +23.6%]
  Search                   5500      4340  +26.7%  [+25.4%, +27.8%]
  Social1                 12423     10405  +19.4%  [+18.1%, +20.4%]
  Social2                  9104      8050  +13.1%  [+11.8%, +14.1%]
  Sports                  22436     19062  +17.7%  [+15.0%, +26.9%]
  Video                   17912     12632  +41.8%  [+40.8%, +42.8%]
  Geometric mean                           +19.6%  [+18.5%, +20.8%]

Speedometer3, M1 Pinpoint (lower is better except Score,
significant results at 95% CI only, ordered by increasing goodness):

  TodoMVC-JavaScript-ES6-Webpack            [ +0.6%,  +2.2%]
  TodoMVC-React-Redux                       [ +0.2%,  +0.9%]
  Editor-TipTap                             [ +0.2%,  +0.6%]
  Charts-chartjs                            [ -0.9%,  -0.1%]
  TodoMVC-Backbone                          [ -0.8%,  -0.1%]
  TodoMVC-JavaScript-ES5                    [ -0.8%,  -0.1%]
  TodoMVC-jQuery                            [ -0.8%,  -0.2%]
  TodoMVC-React                             [ -1.1%,  -0.3%]
  TodoMVC-Angular                           [ -1.5%,  -0.3%]
  TodoMVC-Preact                            [ -3.0%,  -1.4%]
  TodoMVC-React-Complex-DOM                 [ -3.7%,  -2.6%]
  TodoMVC-WebComponents                     [ -5.5%,  -4.8%]
  TodoMVC-Lit                               [ -6.6%,  -5.7%]

  Score                                     [ +0.7%,  +1.0%]

We put it behind the CSSMPCImprovement flag (default on), to be able
to fold it into the ongoing GWS experiment.

Bug: 1504480
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/Id47631629f90ad049181957adce47e330a512693">Id47631629f90ad049181957adce47e330a512693</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/5149687">https://chromium-review.googlesource.com/c/chromium/src/+/5149687</a>
Reviewed-by: Rune Lillesveen &lt;futhark@chromium.org&gt;
Commit-Queue: Steinar H Gunderson &lt;sesse@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1242371}
</pre>

</body>
</html>
