<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1010464/"> 1010464</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/e7924dc02c284f27de5833248781056b4e43054a">e7924dc02c284f27de5833248781056b4e43054a</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1010448/">1010448</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/551209eed2159a9d37cc74a3b1c78ca04f3eb6ff">551209eed2159a9d37cc74a3b1c78ca04f3eb6ff</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   e7924dc02c284f27de5833248781056b4e43054a
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/e7924dc02c284f27de5833248781056b4e43054a">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/e7924dc02c284f27de5833248781056b4e43054a.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Yao Qijing &lt;yaoqq@google.com&gt;
  </td>
  <td>
   Fri Jun 03 06:39:35 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Fri Jun 03 06:39:35 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/e7924dc02c284f27de5833248781056b4e43054a/">
    fcdf40a9b1201a19aa5140f9eab7cbf604df1bba
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/e7924dc02c284f27de5833248781056b4e43054a%5E">
    efe9bb91082a859dc8ec5733e5f1923fc915a516
   </a>
   <span>
    [
    <a href="/chromium/src/+/e7924dc02c284f27de5833248781056b4e43054a%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">SetScale when client trigger SetBounds

The CL is part of the effort to fix the bounds calculation issue when
moving an ARC window between displays with Ctrl+Alt+M shortcut.

Currently, when moving an ARC window to another display with mouse, a
SetBoundsInScreen() is triggered when EndDragImpl() happens, which moves
the current window to the new display before notifying Android. This
workflow also triggers ClientControlledShellSurface to SetScale() -
updates the |pending_scale_| with the device_scale_factor of the new
display. Then when SetBound() is called from ARC, dp is calculated from
the client bounds with the updated |pending_scale_|.

However, for the case when moving the window with shortcut keys,
SetBoundsInScreen() is only triggered when commit() happens, which is
after SetBounds() has already finished calculating dp with the dsf of the
old display, and the wrong dp value is used in commit(). Therefore, we need to figure out a way to update the scale at an earlier stage.

Ideally, it would be better to also trigger SetBoundsInScreen() before
notifying Android in the same way as in dragging cases, but extra effort
is needed to ensure that the |pending_scale_| won't be overwritten in
the upcoming commit()s (eg. flipping the kLockedToRootKey property in
dragging cases). This commit circumvents that by always calling SetScale
if use_default_scale_cancellation_ is false(where we can assume that we
are in R and onward) when SetBounds is triggered by client, so that the
calculation of dp can be using the dsf of the new display.

Test: Manual Testing
Test: ClientControlledShellSurfaceTest.SetBoundsWithAndWithoutDefaultScaleCancellation
Bug: b/204251254
Bug: b/216250765
Bug: b/204265498
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/Ia70557373d26ebff1a70e9ebe9ccf219c81fb45a">Ia70557373d26ebff1a70e9ebe9ccf219c81fb45a</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3670321">https://chromium-review.googlesource.com/c/chromium/src/+/3670321</a>
Commit-Queue: Qijing Yao &lt;yaoqq@google.com&gt;
Reviewed-by: Toshiki Kikuchi &lt;toshikikikuchi@chromium.org&gt;
Reviewed-by: Mitsuru Oshima &lt;oshima@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1010464}
</pre>

</body>
</html>
