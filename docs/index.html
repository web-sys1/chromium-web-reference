<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/958333/"> 958333</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/bb7b6dd9432c52c78fa3a87687be3943df8e31fe">bb7b6dd9432c52c78fa3a87687be3943df8e31fe</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/958277/">958277</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/9a691afd4423b31e7fe30d4201115c7d158bd9b1">9a691afd4423b31e7fe30d4201115c7d158bd9b1</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   bb7b6dd9432c52c78fa3a87687be3943df8e31fe
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/bb7b6dd9432c52c78fa3a87687be3943df8e31fe">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/bb7b6dd9432c52c78fa3a87687be3943df8e31fe.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Nick Diego Yamane &lt;nickdiego@igalia.com&gt;
  </td>
  <td>
   Wed Jan 12 23:04:50 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Wed Jan 12 23:04:50 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/bb7b6dd9432c52c78fa3a87687be3943df8e31fe/">
    816fadabe92f304da687f0fd3b54de8659d48174
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/bb7b6dd9432c52c78fa3a87687be3943df8e31fe%5E">
    4a7169728f60ca2b96b7ea605cac494f277cd0bd
   </a>
   <span>
    [
    <a href="/chromium/src/+/bb7b6dd9432c52c78fa3a87687be3943df8e31fe%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">wayland: fix pickled data exchange in drag-and-drop sessions

Recently, in crrev.com/c/3330489, in order to fix a crash, the Pickle
reconstruction at exo::DragDropOperation was (incorrectly!) modified,
causing regressions in other DnD use cases that rely on "custom data"
exchange, more specifically Chrome's WebUI tab drag-and-drop, see
crbug.com/1284996 for more details.

After re-analyzing it, it turns out that the root issue is at client
side, ie: ozone/wayland. Basically, when the offered data map contains
both string and custom data representations, the string byte array was
wrongly sent for custom data mime type, which leads to unhandled edge
cases in base::Pickle construction at Exo side.

This CL fixes it by:

1. Applying the right priority when extracting data to transfer in
   response to wl_data_source.send event.
2. Reverting exo::DragDropOperation changes in crrev.com/c/3330489. The
   original impl was actually correct.

Additionally, a unit test is added to prevent future similar regressions
in Wayland's OSExchangeDataProvide impl.

R=oshima, tonikitoo@igalia.com

Bug: 1284996, 1271311
Test: Covered by ozone_unittests.
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/Idee83f00b028a7b5b024a269f0b3b2a3aba47069">Idee83f00b028a7b5b024a269f0b3b2a3aba47069</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3379541">https://chromium-review.googlesource.com/c/chromium/src/+/3379541</a>
Reviewed-by: Antonio Gomes &lt;tonikitoo@igalia.com&gt;
Reviewed-by: Mitsuru Oshima &lt;oshima@chromium.org&gt;
Commit-Queue: Nick Yamane &lt;nickdiego@igalia.com&gt;
Cr-Commit-Position: refs/heads/main@{#958333}
</pre>

</body>
</html>
