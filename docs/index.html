<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1001467/"> 1001467</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/2f0ae637ac3119e913943820db2aea499675a911">2f0ae637ac3119e913943820db2aea499675a911</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1001461/">1001461</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/b93a8d17e9a1350846b49b11d1f770466e4be5fd">b93a8d17e9a1350846b49b11d1f770466e4be5fd</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   2f0ae637ac3119e913943820db2aea499675a911
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/2f0ae637ac3119e913943820db2aea499675a911">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/2f0ae637ac3119e913943820db2aea499675a911.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Steinar H. Gunderson &lt;sesse@chromium.org&gt;
  </td>
  <td>
   Tue May 10 12:53:04 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Tue May 10 12:53:04 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/2f0ae637ac3119e913943820db2aea499675a911/">
    6d1915d837df43df470e6e25ba1c83eba65b44ee
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/2f0ae637ac3119e913943820db2aea499675a911%5E">
    010704b0367fdb3f14ef153c78aa52205fae3c06
   </a>
   <span>
    [
    <a href="/chromium/src/+/2f0ae637ac3119e913943820db2aea499675a911%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">Optimize SubstringSetMatcher [patch 3/5, replace flat_map]

Replace the base::flat_map&lt;char, NodeID&gt; with a somewhat more custom
data structure. This is significantly tighter on memory, while also
increasing performance.

The full details are in the comments, but in general, we pack the label
and a 23-bit node ID together in a 32-bit block, which immediately
halves the RAM used for edges (pair&lt;char, NodeID&gt; used 64 bits,
due to padding). Furthermore, we also reduce the size of each node,
by implementing our own smaller size and capacity counters; no node
can have more than 259 outgoing edges, so a uint32_t is meaningless
for this. Finally, since most nodes have very few edges, we add
a special case for when there are two edges or fewer, where we store
those edges inline in the node instead of on the heap. This saves on
RAM and memory allocation time, plus makes for less pointer cahsing.

Note that this changes node IDs to be 23-bit instead of 32-bit,
which means we can hold 8M nodes instead of 4B. This is still
tens of megabytes of data in practice, though; if it turns out
to be a problem for some applications, it would probably be possible
to have a template parameter for 31-bit IDs (causing Node to go
from 12 to 14 bytes in the process).

We stop doing binary search and replace it with a simple linear one
instead, which is just as fast (since we generally have few edges)
and allows us to get by without sorting nodes.

SubstringSetMatcher.init_time:      60956 -&gt; 36772 us (+65.8% perf)
SubstringSetMatcher.match_time:       138 -&gt;   129 us (+ 7.0% perf)
SubstringSetMatcher.memory_usage:   25879 -&gt; 13047 kB (-49.6% RAM)

Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I9ef6b24e5d20dff10a7736086584372d1c92c636">I9ef6b24e5d20dff10a7736086584372d1c92c636</a>
Bug: 1319422
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3596141">https://chromium-review.googlesource.com/c/chromium/src/+/3596141</a>
Commit-Queue: Steinar H Gunderson &lt;sesse@chromium.org&gt;
Reviewed-by: Dominic Battr√© &lt;battre@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1001467}
</pre>

</body>
</html>
