<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1111638/"> 1111638</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/539d958b2bfecdc374a25ff2f106004957f9b73e">539d958b2bfecdc374a25ff2f106004957f9b73e</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1111621/">1111621</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/5141395fa3e25119a73f528d4dabdaa3b7b6b382">5141395fa3e25119a73f528d4dabdaa3b7b6b382</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   539d958b2bfecdc374a25ff2f106004957f9b73e
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/539d958b2bfecdc374a25ff2f106004957f9b73e">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/539d958b2bfecdc374a25ff2f106004957f9b73e.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   manukh &lt;manukh@chromium.org&gt;
  </td>
  <td>
   Wed Mar 01 16:50:25 2023
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Wed Mar 01 16:50:25 2023
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/539d958b2bfecdc374a25ff2f106004957f9b73e/">
    8be5693e99792b588f171b9c5f0b195fa3eb29b6
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/539d958b2bfecdc374a25ff2f106004957f9b73e%5E">
    8779bec7ed5ea1c632dc2cc490bec9c14a18c164
   </a>
   <span>
    [
    <a href="/chromium/src/+/539d958b2bfecdc374a25ff2f106004957f9b73e%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">[omnibox][perf] Optimize navigation classifier calls.

Omnibox navigation reverts the omnibox state (model &amp; popup), which
invokes `AutocompleteClassifier::Classify()` 3 times, which adds
non-negligible latency (3ms).

It seems unnecessary to revert and updating the omnibox when it's about
to be redone due to navigation. But it's actually necessary because
a) sometimes the navigation isn't in the same tab (e.g. opening
chrome://settings in incognito) or b) the navigation isn't immediate. So
instead, this CL tries to reduce the time taken to do the revert.

This CL adds 2 optimizations:

a) tldr; when reverting the omnibox view, 1st revert the edit model then
close the popup, instead of vice versa.

Currently on revert, 1st the popup is closed, then the edit model is
reverted. Closing the popup will stop the running autocomplete
providers, which notifies autocomplete observers that autocomplete state
has changed, which updates the location bar view. However, because the
model hasn't yet been reverted, the location bar view thinks there's
still input in progress, so it tries to autocomplete the temp text to
determine the icons and text bolding. This results in 3 redundant
`Classify()` calls (i.e. all calls are classifying the same temp text).
To add insult to injury, this expensive update is immediately discarded
when the edit model revert re-updates the location bar view.

This CL flips the order, 1st reverting the model then closing the popup.
This ensures that when the popup is closed, we know there is no temp
text and don't need to run `Classify()`. We still update the location
bar view twice though; I haven't looked into how expensive that is,
since now at least it's being updated with the same text and icons so
perhaps the views are smart enough to short circuit.

b) tldr; fix the `current_match_` cache to not be almost always empty.

`OmniboxController` has a `current_match_` that is intended to cache the
current match. When it's unavailable, the edit model resorts to
classifying the view text, which runs the sync autocomplete pass, which
is expensive (1ms). This cached match is almost always empty. It's set
only after the sync autocomplete pass, but it's cleared almost
immediately afterwards.

This CL sets `current_match_` on autocomplete change, selection change,
and tab switch. And it's never cleared, instead being replacing with
the new match; so its hit rate is now 100%.

This CL also moves `current_match_` from the omnibox controller to the
edit model since that's where it's both used and update.


The touched code is convoluted. To ensure we don't introduce unwanted
consequences, and to measure the improvements, these 2 changes are
guarded by independent features.

Also adds 3 timing histograms for `Classify()`, `RevertAll()`, and
`OpenMatch()`.

Bug: 806262, 1418490
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I08558b2269a43d6a2ddbd777de6403f6a561afa9">I08558b2269a43d6a2ddbd777de6403f6a561afa9</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/4273874">https://chromium-review.googlesource.com/c/chromium/src/+/4273874</a>
Reviewed-by: Orin Jaworski &lt;orinj@chromium.org&gt;
Commit-Queue: manuk hovanesian &lt;manukh@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1111638}
</pre>

</body>
</html>
