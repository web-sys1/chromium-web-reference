<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1118506/"> 1118506</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/3d4aab7a9e6d2e0d1f2ea0711edd873f307375bc">3d4aab7a9e6d2e0d1f2ea0711edd873f307375bc</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1118471/">1118471</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/42513c0845a7dfed8438da292a6cbb88d684e01b">42513c0845a7dfed8438da292a6cbb88d684e01b</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   3d4aab7a9e6d2e0d1f2ea0711edd873f307375bc
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/3d4aab7a9e6d2e0d1f2ea0711edd873f307375bc">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/3d4aab7a9e6d2e0d1f2ea0711edd873f307375bc.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   David Benjamin &lt;davidben@chromium.org&gt;
  </td>
  <td>
   Fri Mar 17 03:41:45 2023
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Fri Mar 17 03:41:45 2023
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/3d4aab7a9e6d2e0d1f2ea0711edd873f307375bc/">
    1f239996bc34d4d4dd5728210e440f59c0e12fe8
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/3d4aab7a9e6d2e0d1f2ea0711edd873f307375bc%5E">
    ac4b6ee92e7ae034f13e5a83b25d468fc6aa68fb
   </a>
   <span>
    [
    <a href="/chromium/src/+/3d4aab7a9e6d2e0d1f2ea0711edd873f307375bc%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">Fix race conditions in Watchdog subclasses

There were two suppressions for what seems to have been the same
original cause. The suppressions prevent us from catching bugs when
something else in the browser uses Watchdog.

There were two race conditions, one of which actually impacts the entire
Watchdog subclassing API, not just tests:

First, both the watchdog thread and the test thread access
alarm_counter. This can be fixed by just using an atomic.

The second race condition is one that TSan seems to no longer notice
once an atomic is used: until ~WatchDog() joins the thread, the watchdog
thread may call Alarm(). But by then, the subclass has been destructed.
That means it's possible to race the watchdog thread calling alarm with
the subclass being destroyed. This can result in data races in both the
subclass state and also the vtable pointer itself. (When ~Derived()
hands off to ~Base(), the vtable pointer is rewired to Base's vtable, so
that virtual method classes use the base class's version.)

Instead, replace subclassing with a Delegate interface that can outlive
the Watchdog. While I'm here, reduce unnecessary allocations and
indirections in ShutdownWatcherHelper by flattening it. Also switch the
ad-hoc thread-id DCHECKs to THREAD_CHECKER to avoid allocating space for
it in release mode.

Also remove the CustomThreadWatcher suppression. That class no
longer exists, though based on the linked bug, it looks like it may
have been another watchdog race.

Finally, remove Disarm() classes to watchdogs that are going to be
destroyed immediately afterwards anyway. Disarming the watchdog
immediately before destroying it is redundant.

Bug: 120808, 308590
Cq-Include-Trybots: luci.chromium.try:linux_chromium_tsan_rel_ng
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I83dc4bf3d1a93de0cdfd4e870a254dfdd6d0c739">I83dc4bf3d1a93de0cdfd4e870a254dfdd6d0c739</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/4335573">https://chromium-review.googlesource.com/c/chromium/src/+/4335573</a>
Reviewed-by: Gabriel Charette &lt;gab@chromium.org&gt;
Reviewed-by: Jamie Walch &lt;jamiewalch@chromium.org&gt;
Reviewed-by: Daniel Rubery &lt;drubery@chromium.org&gt;
Reviewed-by: Steven Holte &lt;holte@chromium.org&gt;
Commit-Queue: David Benjamin &lt;davidben@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1118506}
</pre>

</body>
</html>
