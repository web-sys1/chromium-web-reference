<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/938879/"> 938879</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/34015bacdb0845a226035749e1077c499419970f">34015bacdb0845a226035749e1077c499419970f</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/938857/">938857</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/c3f386244e4078a71704095a3ce7f0df7e064b25">c3f386244e4078a71704095a3ce7f0df7e064b25</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   34015bacdb0845a226035749e1077c499419970f
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/34015bacdb0845a226035749e1077c499419970f">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/34015bacdb0845a226035749e1077c499419970f.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Anders Hartvoll Ruud &lt;andruud@chromium.org&gt;
  </td>
  <td>
   Fri Nov 05 18:55:20 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Fri Nov 05 18:55:20 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/34015bacdb0845a226035749e1077c499419970f/">
    f6fe79f728acaad63f6d6598b471091a35cf0839
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/34015bacdb0845a226035749e1077c499419970f%5E">
    48f5612fd911ce80a0c25a0c0816406daff7fe02
   </a>
   <span>
    [
    <a href="/chromium/src/+/34015bacdb0845a226035749e1077c499419970f%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">[mq-4] Treat a final state of kReadRestrictor as an error

We currently explicitly call ProcessToken() on an empty range to
make it possible for handler functions to check for range.AtEnd()
and take some action based on that. This call has one of three
possible effects:

 1) kDone -&gt; kDone (i.e. no effect).
 2) kReadRestrictor -&gt; kSkipUntilComma
 3) kSkipUntilComma -&gt; kReadRestrictor + AddMediaQuery

In case (2), this means that we add "not all" at the call-site after
ProcessToken(empty) has finished. This happens when there's a valid
query followed by a single final comma, e.g. "(color),".

In case (3), we add "not all" *during* SkipUntilComma, and then
prevent an additional erroneous "not all" from being added
by checking CurrentMediaQueryChanged(). This happens when there's
an invalid query followed by a single final comma, e.g. "invalid,".

If we instead remove ProcessToken(empty), then for case (2)
we can just handle kReadRestrictor identically to kSkipUntilComma,
and for case (3) the fact that we remain kSkipUntilComma will produce
the "not all" we previously produced inside the handler.

Bug: 962417
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I75e1b41560a235e4c03877c0fec83a5f7a19810c">I75e1b41560a235e4c03877c0fec83a5f7a19810c</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3253389">https://chromium-review.googlesource.com/c/chromium/src/+/3253389</a>
Commit-Queue: Anders Hartvoll Ruud &lt;andruud@chromium.org&gt;
Reviewed-by: Kevin Babbitt &lt;kbabbitt@microsoft.com&gt;
Cr-Commit-Position: refs/heads/main@{#938879}
</pre>

</body>
</html>
