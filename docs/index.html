<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1073694/"> 1073694</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/133cf6e28fa8918a27794103283fcb06034cc37a">133cf6e28fa8918a27794103283fcb06034cc37a</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1073679/">1073679</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/06fcef68cffd414c23ed5c113bddd8d356989dc4">06fcef68cffd414c23ed5c113bddd8d356989dc4</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   133cf6e28fa8918a27794103283fcb06034cc37a
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/133cf6e28fa8918a27794103283fcb06034cc37a">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/133cf6e28fa8918a27794103283fcb06034cc37a.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Jesse McKenna &lt;jessemckenna@google.com&gt;
  </td>
  <td>
   Sat Nov 19 02:16:50 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Sat Nov 19 02:16:50 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/133cf6e28fa8918a27794103283fcb06034cc37a/">
    ddbc77f178c51d00d410aa5991f4d67ef7c379c7
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/133cf6e28fa8918a27794103283fcb06034cc37a%5E">
    f86cdf272a8d2a0427d7e05e996811a19cb611e9
   </a>
   <span>
    [
    <a href="/chromium/src/+/133cf6e28fa8918a27794103283fcb06034cc37a%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">Reland "Use kernel32 version for OS deprecation infobar"

This reverts commit 1779ada5e6288f3a8b012c9b2ad5863abb4a676e.

Reason for revert: This reland adds ScopedAllowBlocking to
Kernel32Version(). The original change was reverted because
Kernel32Version() calls CreateFileVersionInfoWin(), which uses
ScopedBlockingCall to assert that it's not called on the main
thread.

However, allowing blocking for Kernel32Version() should be okay,
because:
* it only calls the CreateFileVersionInfoWin() once, then caches
  its result in a function-local static variable
* kernel32.dll should always be in the OS's file cache because it
  is used by all processes

Original change's description:
&gt; Revert "Use kernel32 version for OS deprecation infobar"
&gt;
&gt; This reverts commit 251f13a00be12e784c8908e3396b291ff90fa18e.
&gt;
&gt; Reason for revert: This seems to cause racey DCHECK failures on
&gt; tip of tree, because Kernel32Version() is not meant to be called
&gt; on the UI thread (as it includes a ScopedBlockingCall).
&gt;
&gt; This is racey because it only happens if the infobar code is the
&gt; first caller to Kernel32Version(), which is how it slipped by.
&gt;
&gt; The reland should call Kernel32Version() on a separate thread.
&gt;
&gt; DCHECK call stack:
&gt; ```
&gt; base.dll!logging::LogMessage::~LogMessage() Line 712
&gt; base.dll!logging::CheckError::~CheckError() Line 197
&gt; base.dll!base::internal::AssertBlockingAllowed() Line 109
&gt; base.dll!base::ScopedBlockingCall::ScopedBlockingCall(const base::Location &amp; from_here, base::BlockingType blocking_type) Line 45
&gt; base.dll!FileVersionInfoWin::CreateFileVersionInfoWin(const base::FilePath &amp; file_path) Line 79
&gt; base.dll!base::win::OSInfo::Kernel32BaseVersion::&lt;lambda_1&gt;::operator()() Line 241
&gt; base.dll!base::win::OSInfo::Kernel32BaseVersion() Line 240
&gt; base.dll!base::win::OSInfo::Kernel32Version() Line 219
&gt; chrome.dll!`anonymous namespace'::GetRealOSVersion() Line 22
&gt; chrome.dll!`anonymous namespace'::IsObsoleteOsVersion() Line 26
&gt; chrome.dll!ObsoleteSystem::IsObsoleteNowOrSoon() Line 33
&gt; chrome.dll!AddInfoBarsIfNecessary(Browser * browser, Profile * profile, const base::CommandLine &amp; startup_command_line, chrome::startup::IsFirstRun is_first_run, bool is_web_app) Line 131
&gt; chrome.dll!StartupBrowserCreatorImpl::DetermineURLsAndLaunch(chrome::startup::IsProcessStartup process_startup) Line 460
&gt; ```
&gt;
&gt; Original change's description:
&gt; &gt; Use kernel32 version for OS deprecation infobar
&gt; &gt;
&gt; &gt; This change makes the code to detect obsolete Windows versions get the
&gt; &gt; OS version from `Kernel32Version()` instead of `GetVersion()`.
&gt; &gt;
&gt; &gt; If Chrome is run in App Compatibility mode [1], `GetVersion()` will
&gt; &gt; return the compatibility-mode version rather than the true system
&gt; &gt; version. This may be done by Windows automatically in certain cases, or
&gt; &gt; by system administrators, anti-virus software, etc.
&gt; &gt;
&gt; &gt; The code to detect obsolete Windows versions is used to display warnings
&gt; &gt; that the OS is no longer supported (e.g., the Windows 7/8 deprecation
&gt; &gt; infobar recently added [2]). This means the current code shows warnings
&gt; &gt; to users in compatibility mode for unsupported versions even if their
&gt; &gt; actual OS is Windows 10, which can confuse users [3].
&gt; &gt;
&gt; &gt; `Kernel32Version()` returns the correct OS version by checking the
&gt; &gt; version of kernel32.dll, and is used in e.g., Crashpad to ensure the
&gt; &gt; right version is recorded.
&gt; &gt;
&gt; &gt; This change was tested by looking for the Windows 7/8 deprecation
&gt; &gt; infobar on the following systems:
&gt; &gt; * Windows 10 (not shown)
&gt; &gt; * Windows 10 in compatibility mode for Windows 8 (not shown)
&gt; &gt; * Windows 7 (shown)
&gt; &gt; * Windows 8.1 (shown)
&gt; &gt; * Windows 8.1 in compatibility mode for Windows 7
&gt; &gt;   (shown, infobar correctly says the OS version is Windows 8.1)
&gt; &gt;
&gt; &gt; [1] done by:
&gt; &gt;   1. right-clicking a taskbar icon
&gt; &gt;   2. navigating to Properties &gt; Compatibility
&gt; &gt;   3. checking the box "Run this program in compatibility mode for"
&gt; &gt;   4. choosing the desired Windows version in the dropdown menu
&gt; &gt;   5. clicking OK
&gt; &gt;   6. launching Chrome via the taskbar icon
&gt; &gt; [2] crrev.com/c/4004000
&gt; &gt; [3] example support thread from the Win XP/Vista deprecation:
&gt; &gt;     <a href="https://support.google.com/chrome/thread/99522885/chrome-thinks-i-m-using-xp-but-i-m-using-windows-10?hl=en">https://support.google.com/chrome/thread/99522885/chrome-thinks-i-m-using-xp-but-i-m-using-windows-10?hl=en</a>
&gt; &gt;
&gt; &gt; Bug: 1377525
&gt; &gt; Change-Id: <a href="https://chromium-review.googlesource.com/#/q/Ifd413d7efd941e7bb6c7d278ae2414e360147fab">Ifd413d7efd941e7bb6c7d278ae2414e360147fab</a>
&gt; &gt; Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/4031572">https://chromium-review.googlesource.com/c/chromium/src/+/4031572</a>
&gt; &gt; Reviewed-by: Bruce Dawson &lt;brucedawson@chromium.org&gt;
&gt; &gt; Reviewed-by: Will Harris &lt;wfh@chromium.org&gt;
&gt; &gt; Commit-Queue: Jesse McKenna &lt;jessemckenna@google.com&gt;
&gt; &gt; Cr-Commit-Position: refs/heads/main@{#1073035}
&gt;
&gt; Bug: 1377525
&gt; Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I556abe74b956c3fd80a32d5e3c199bbb3e761bed">I556abe74b956c3fd80a32d5e3c199bbb3e761bed</a>
&gt; No-Presubmit: true
&gt; No-Tree-Checks: true
&gt; No-Try: true
&gt; Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/4038682">https://chromium-review.googlesource.com/c/chromium/src/+/4038682</a>
&gt; Commit-Queue: Jesse McKenna &lt;jessemckenna@google.com&gt;
&gt; Bot-Commit: Rubber Stamper &lt;rubber-stamper@appspot.gserviceaccount.com&gt;
&gt; Reviewed-by: Will Harris &lt;wfh@chromium.org&gt;
&gt; Reviewed-by: Bruce Dawson &lt;brucedawson@chromium.org&gt;
&gt; Cr-Commit-Position: refs/heads/main@{#1073629}

Bug: 1377525
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I20abe017da9b38bd7ba0f7a24f4f08e7dba386b1">I20abe017da9b38bd7ba0f7a24f4f08e7dba386b1</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/4039482">https://chromium-review.googlesource.com/c/chromium/src/+/4039482</a>
Commit-Queue: Jesse McKenna &lt;jessemckenna@google.com&gt;
Reviewed-by: Will Harris &lt;wfh@chromium.org&gt;
Reviewed-by: Bruce Dawson &lt;brucedawson@chromium.org&gt;
Reviewed-by: Lei Zhang &lt;thestig@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1073694}
</pre>

</body>
</html>
