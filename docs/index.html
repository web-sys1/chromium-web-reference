<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1022439/"> 1022439</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/5dd30f1220cc02444c67d63f73ec94d849b7279e">5dd30f1220cc02444c67d63f73ec94d849b7279e</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1022433/">1022433</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/0717e962fae721ed6931967f276bafc67ba2f23a">0717e962fae721ed6931967f276bafc67ba2f23a</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   5dd30f1220cc02444c67d63f73ec94d849b7279e
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/5dd30f1220cc02444c67d63f73ec94d849b7279e">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/5dd30f1220cc02444c67d63f73ec94d849b7279e.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Gabriel Charette &lt;gab@chromium.org&gt;
  </td>
  <td>
   Sat Jul 09 15:14:22 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Sat Jul 09 15:14:22 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/5dd30f1220cc02444c67d63f73ec94d849b7279e/">
    f3dd9cfda14faf11a56aa3720070773d9db94c62
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/5dd30f1220cc02444c67d63f73ec94d849b7279e%5E">
    52a7cb0f50a5198350544e30eeb1c627c6760149
   </a>
   <span>
    [
    <a href="/chromium/src/+/5dd30f1220cc02444c67d63f73ec94d849b7279e%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">[base] Report MessagePump phases timings to UMA and tracing

Augments the ThreadController::RunLevelTracker logic which is behind
"ThreadController active" to account for each of 7 phases in the message
pump (cross-platform, though kNativeWork support depends on the
instrumentation of MessagePump::Delegate::BeginWorkItem by that
platform).

Example trace: goto.google.com/avttj
BrowserThread::UI with nesting: <a href="https://snipboard.io/doibNk.jpg">https://snipboard.io/doibNk.jpg</a>
Zoomed in to a single task: <a href="https://snipboard.io/jhNTid.jpg">https://snipboard.io/jhNTid.jpg</a>
BrowserThread::IO: <a href="https://snipboard.io/q7M5ei.jpg">https://snipboard.io/q7M5ei.jpg</a>
(BrowserThread::IO doesn't support kScheduled for IPCs, but it
 eventually could if the `queue_time` was plubmed)

Note: The ApplicationTask phase always visually outscopes the matching
RunTask event. This currently looks like phases are overlapping because
the "sequence_manager" specific events like "RunNormalPriorityTask" are
emitted as async events from SelectNextTask. In a follow-up, I will have
all of these align on the same LazyNow (this CL already makes extensive
use of LazyNow for this reason but there's more to do for this case).

Prior iterations of this CL (initial patch sets) which help understand
why this is the best approach (the tricky part is mostly around the
cross-thread kScheduled phase):
1) ThreadController::RunLevelTracker::OnWorkScheduled : To be invoked
   from ThreadController::ScheduleWork impls to store the timestamp of
   the last ScheduleWork. This is racy as ScheduleWork() can happen
   while the pump is already running (e.g. when it wakes up for native
   work, like input). We could consider kScheduled=0ms when we miss the
   timing, but then it's also racy who gets to clear the bit on idle
   (don't want the next wake-up to use an old timing and misreport a
   long kScheduled phase).

2) Simulate toplevel.flow PostTask tracing events by instrumenting
   ThreadControllerWithMessagePumpImpl::WillQueueTask and remembering
   sequence_num's (unique ID and happens-before-task-is-enqueued removes
   problems from (1) but requires cross-thread state for tasks that
   might not trigger ScheduleWork). Cross-thread can be solved by
   storing the state in PendingTask, but we already have that
   under queue_time! =&gt; (3)

3) ThreadControllerWithMessagePumpImpl::TimeKeeper. Single-threaded,
   detect back-from-idle from additional state and use queue_time to
   report kScheduled.

4) Move TimeKeeper into ThreadController::RunLevelTracker and merge the
   two state machines. i.e. in order to support native work and
   nesting, the state required in (3) is really the RunLevelTracker's
   state. Hence this CL.

Bug: 1329717
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I8c993322f641561349adde95e82bb150c17cc962">I8c993322f641561349adde95e82bb150c17cc962</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3645137">https://chromium-review.googlesource.com/c/chromium/src/+/3645137</a>
Commit-Queue: Gabriel Charette &lt;gab@chromium.org&gt;
Reviewed-by: Etienne Pierre-Doray &lt;etiennep@chromium.org&gt;
Reviewed-by: Alexander Timin &lt;altimin@chromium.org&gt;
Reviewed-by: Francois Pierre Doray &lt;fdoray@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1022439}
</pre>

</body>
</html>
