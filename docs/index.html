<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/969905/"> 969905</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/ccf739cd62d60b2206f78b2975fcd87e56d30b0e">ccf739cd62d60b2206f78b2975fcd87e56d30b0e</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/969877/">969877</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/b1e98b032394defd437cab74729812fa8b22b7a4">b1e98b032394defd437cab74729812fa8b22b7a4</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   ccf739cd62d60b2206f78b2975fcd87e56d30b0e
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/ccf739cd62d60b2206f78b2975fcd87e56d30b0e">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/ccf739cd62d60b2206f78b2975fcd87e56d30b0e.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Henrik Boström &lt;hbos@chromium.org&gt;
  </td>
  <td>
   Fri Feb 11 12:18:02 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Fri Feb 11 12:18:02 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/ccf739cd62d60b2206f78b2975fcd87e56d30b0e/">
    5c6c8ddc8f496f8361a4df0f520b2475d1353bd0
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/ccf739cd62d60b2206f78b2975fcd87e56d30b0e%5E">
    81e689c5bf0442a7f01bc9f13a053cfcf636a567
   </a>
   <span>
    [
    <a href="/chromium/src/+/ccf739cd62d60b2206f78b2975fcd87e56d30b0e%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">[WebRTC] MetronomeSource not to cause Idle Wake Ups if there is no work.

Prior to this CL, the MetronomeSource became active at 64 Hz as soon as
it had any listeners, regardless if those listeners had any wakeup time
set. This translates into an Idle Wake Up even when we don't have any
work to do inside OnMetronomeTick().

In this CL, MetronomeSource is updated only to schedule tasks on
metronome ticks where we have work to do, i.e. where at least one
listener has a wakeup time that is not in the future.

With this CL we only wake up if we needed to wake up anyway, which
greatly decreases the risk of regressions when MetronomeSource is used.
Most notably, we no longer pay any Idle Wake Up cost when we have
inactive RTCPeerConnections (0 Hz added instead of 64 Hz). Repro:
<a href="https://jsfiddle.net/henbos/m1x0pb6w/">https://jsfiddle.net/henbos/m1x0pb6w/</a>

To achieve flexible scheduling of metronome ticks,
PostCancelableDelayedTaskAt() is used instead of a RepeatingTimer.
This also means that if there exists multiple MetronomeSources in
multiple Chrome processes, these will all align with each other.

With this CL, the threading model of MetronomeSource is simplified with
all variables only being used on the metronome sequence so we can remove
all locks, the only exception being the listener's "is_active_lock_".

Bug: chromium:1295198, chromium:1296138
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/Ib69772db35a517a4618f2921422c411330eb84f6">Ib69772db35a517a4618f2921422c411330eb84f6</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3447229">https://chromium-review.googlesource.com/c/chromium/src/+/3447229</a>
Reviewed-by: Evan Shrubsole &lt;eshr@google.com&gt;
Reviewed-by: Mirko Bonadei &lt;mbonadei@chromium.org&gt;
Reviewed-by: Etienne Pierre-Doray &lt;etiennep@chromium.org&gt;
Commit-Queue: Henrik Boström &lt;hbos@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#969905}
</pre>

</body>
</html>
