<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1060769/"> 1060769</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/5c44ece5d285d606ef8b31302d8c95af889b8bb7">5c44ece5d285d606ef8b31302d8c95af889b8bb7</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1060740/">1060740</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/18b1296725312759525cd3b2f596b14874fda272">18b1296725312759525cd3b2f596b14874fda272</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   5c44ece5d285d606ef8b31302d8c95af889b8bb7
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/5c44ece5d285d606ef8b31302d8c95af889b8bb7">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/5c44ece5d285d606ef8b31302d8c95af889b8bb7.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Xiaohan Wang &lt;xhwang@chromium.org&gt;
  </td>
  <td>
   Wed Oct 19 00:24:12 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Wed Oct 19 00:24:12 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/5c44ece5d285d606ef8b31302d8c95af889b8bb7/">
    1f225cd0c006a33bd66cabe16478217b7d917eb2
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/5c44ece5d285d606ef8b31302d8c95af889b8bb7%5E">
    63f921ea6ccb58a17153f904496b80c63decafb9
   </a>
   <span>
    [
    <a href="/chromium/src/+/5c44ece5d285d606ef8b31302d8c95af889b8bb7%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">media: Fix InterfaceFactoryImpl renderer disconnection handling

The buildflag guards used for handling `renderer_receivers_`
disconnection errors are different from those for `renderer_receivers_`
declaration.

When using MojoRendererService for clear playback, during tear down,
InterfaceFactoryImpl gets disconnected first. If there's still
MojoRendererService there, it should not be destructed, to prevent
this disconnection error. But due to the bug, IsEmpty() returns true
and InterfaceFactoryImpl is destructed, which then will destruct
MediaFoundationRenderer.

This can also happen when we have both a MojoRendererService and
MojoCdmService. This should be pretty rare since in WebMediaPlayerImpl
holds a reference to the CDM. So this should only happen when the
disconnection handling of the CDM and the media Renderer gets out
of order. So when the CDM is destroyed, it'll trigger the
OnReceiverDisconnect(), which will check IsEmpty(), which will
return true due to this mismatch, even though the Renderer is still
connected. This will cause the destroy callback be invoked and
InterfaceFactoryImpl destroyed, which will destroy the
MediaFoundationRenderer prematurely, causing a disconnection error in
MediaFoundationRendererClient.

Note that when MojoCdmService is destroyed, the underlying
MediaFoundationCdm will not be destroyed immediately since
MojoRendererService still holds a ref-count to it. It'll only
be destroyed after MediaFoundationRenderer is destroyed, to prevent
playback error caused during the tear down process.

Bug: 1376166
Test: Manually tested and the problem doesn't repro anymore.
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I7f3c1860c5f4b1d7ce2914ead51c1931d1d583bf">I7f3c1860c5f4b1d7ce2914ead51c1931d1d583bf</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3964850">https://chromium-review.googlesource.com/c/chromium/src/+/3964850</a>
Commit-Queue: Xiaohan Wang &lt;xhwang@chromium.org&gt;
Reviewed-by: Frank Li &lt;frankli@microsoft.com&gt;
Cr-Commit-Position: refs/heads/main@{#1060769}
</pre>

</body>
</html>
