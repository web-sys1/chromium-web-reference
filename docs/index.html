<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1037355/"> 1037355</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/bb8bd2a13b46dc5233b941fb9d02fc211657bdce">bb8bd2a13b46dc5233b941fb9d02fc211657bdce</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1037314/">1037314</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/6ee3e732041d97c543a3117c4f9f1ada9812dba8">6ee3e732041d97c543a3117c4f9f1ada9812dba8</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   bb8bd2a13b46dc5233b941fb9d02fc211657bdce
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/bb8bd2a13b46dc5233b941fb9d02fc211657bdce">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/bb8bd2a13b46dc5233b941fb9d02fc211657bdce.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Robert Mader &lt;robert.mader@collabora.com&gt;
  </td>
  <td>
   Sat Aug 20 02:13:17 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Sat Aug 20 02:13:17 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/bb8bd2a13b46dc5233b941fb9d02fc211657bdce/">
    6f53b4fdfe5a0ff87600cbdba0ed2c579662dd28
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/bb8bd2a13b46dc5233b941fb9d02fc211657bdce%5E">
    f93fb6e15b4942b57e3d891a8823aea26a169148
   </a>
   <span>
    [
    <a href="/chromium/src/+/bb8bd2a13b46dc5233b941fb9d02fc211657bdce%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">exo: Implement zwp_linux_dmabuf_v1 v3 and initial v4 support

This series implements full v3 and initial v4 support for the
Wayland zwp_linux_dmabuf_v1 protocol.

EGL and Vulkan Wayland clients use it indirectly and automatically
via Mesa, making them use more optimal DRM modifiers. This should
increase performance in most cases. However, as scanout tranche
support is not optimally implemented yet, on some hardware this may decrease the likelihood that direct scanout fast paths can be used by the DRM backend.

Tested via EGL/DRM, EGL/X11 and GLX/X11 backend on Intel and
AMD hardware.

Notes and observations:
- good test clients are `wayland-info`, `wayland-simple-egl` and `weston-simple-dmabuf-feedback`.
- when used with the X11 EGL backend, i.e. in nested mode, Wayland EGL
  clients do not fall back to swrast software rendering any more but
  can properly exercise the dmabuf paths. That is because v4 allows
  the clients to get the right drm render node. Clients using GBM
  directly can do the same once they implement v4 of the protocol.
- the priviously hardcoded list of formats included formats
  that were actually not supported by either the render backend or
  the driver during testing, notably `AR30`/`DRM_FORMAT_ARGB2101010`/`gfx::BufferFormat::BGRA_1010102`
  (assuming the new code is correct).

Suggested testing parameters:
Native/TTY:
`EGL_PLATFORM=surfaceless out/Default/chrome --force-system-compositor-mode --enable-wayland-server`
Nested:
`out/Default/chrome --ozone-platform=x11 --enable-wayland-server --use-gl=egl`

Additionally `--wayland-server-socket=wayland-1` should be added if there's already a running Wayland compositor of the same user. Wayland clients then need to be started with `WAYLAND_DISPLAY=wayland-1`.

---

exo: Add test for zwp_linux_dmabuf_v1 v3 and v4

1. Allow clients to specify requested protocol version
2. Explicitely check v2, v3 and v4 - in the later case both
   default and surface specific feedback.
3. Check that each format/modifier combination advertised by the
   compositor can be successfully used, both individually and in
   bulk. The later lets the driver choose from a list.

Note: local testing revealed driver that both on Intel and AMD
individual combinations do not work. There is no overlap between
the drivers, suggesting that this is caused by driver bugs.


exo: Add surfaces to scanout candidates when fullscreen

This implements a very simple heuristic for when chances
are high for the compositor to directly scan out the buffer
of a surface to a hardware surface. In that case we want
the feedback mananger to (re)send a feedback with scanout
tranches, making clients (such as Mesa) use formats/modifiers
supported by the CRTC (but may not be optimal for
compositing).

More sophisticated methods used in other compositors most
likely require deeper integration with the scene graph and
the DRM backend (and thus IPC etc.). Thus for now take
a simplistic approach and consider all fullscreen clients
scanout candidates.
This should cover the most urgend cases like gaming, fullscreen
video play etc. and may serve as a good starting point.


exo: Implement zwp_linux_dmabuf_v1 v3 and initial v4 support

- introduce the data structures for v4 support such as per surface
feedbacks, tranches etc.
- determine whether v4 or only v3 support can be advertised based on
render backend capabilities. v4 can not be advertized without correct
render node, which currently can only determined via the EGL/GLES
render backend on the GPU process.
- use DRM formats and modifiers from the render backend / the
GPU process. This ensures that any format/modifier combination
advertised by the protocol is supported by both the driver and the
renderer. This allows to remove the hardcoded format list.
- add GPU specific hardcoded modifiers for scanout tranches, disabled
by default (example data for my two test devices included, using
the `weston-simple-dmabuf-feedback` test client on other compositors).
In the long run this should get replaced with a generic detection
in the DRM backend on the GPU process. As this is quite involved,
stick to an easy solution for now.

This allows Wayland clients, most notable clients using EGL or Vulkan,
to use more optimal modifiers - improving performance etc.


gpu: Add DRM modifiers and render node to capabilities in GPU process

Exo, the Wayland compositor in ChromeOS, needs to know the DRM
formats and respective modifiers that the graphics driver can
import, as well as the used render node. Query these using the
respective EGL extensions if the GLES render backend is used
on ChromeOS and add them to the capabilities.
Only include formats that are advertised as supported in
`gpu_memory_buffer_formats`.


Bug: b:224580219
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I54aaac74cec23c545ac87f06e24d9c6d1a013821">I54aaac74cec23c545ac87f06e24d9c6d1a013821</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3555829">https://chromium-review.googlesource.com/c/chromium/src/+/3555829</a>
Reviewed-by: Vasiliy Telezhnikov &lt;vasilyt@chromium.org&gt;
Reviewed-by: Tom Sepez &lt;tsepez@chromium.org&gt;
Reviewed-by: Geoff Lang &lt;geofflang@chromium.org&gt;
Reviewed-by: Mike West &lt;mkwst@chromium.org&gt;
Commit-Queue: St√©phane Marchesin &lt;marcheu@chromium.org&gt;
Reviewed-by: Mitsuru Oshima &lt;oshima@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1037355}
</pre>

</body>
</html>
