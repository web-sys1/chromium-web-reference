<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/999519/"> 999519</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/7d735558643bc171300cf13fb69edb59789245bf">7d735558643bc171300cf13fb69edb59789245bf</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/999493/">999493</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/40b43254fd15d542628d141501884be11486fee7">40b43254fd15d542628d141501884be11486fee7</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   7d735558643bc171300cf13fb69edb59789245bf
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/7d735558643bc171300cf13fb69edb59789245bf">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/7d735558643bc171300cf13fb69edb59789245bf.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   W. James MacLean &lt;wjmaclean@chromium.org&gt;
  </td>
  <td>
   Wed May 04 18:38:00 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Wed May 04 18:38:00 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/7d735558643bc171300cf13fb69edb59789245bf/">
    f05b4ff113013ea18cc37d8f284b1cb69bfd9dd1
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/7d735558643bc171300cf13fb69edb59789245bf%5E">
    75ef3a5de3a5e65005b3005d2bd3fe3a1b4c89e6
   </a>
   <span>
    [
    <a href="/chromium/src/+/7d735558643bc171300cf13fb69edb59789245bf%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">Remove incorrect CHECK, revise use of sandbox policies.

This CL removes a CHECK introduced in refs/heads/main@{#969578}. The
CHECK was intended to ensure that the sandbox flags that are used to
drive the process isolation for srcdoc iframes with the sandbox
attributeset didn't change after having used them to make the process
isolation decision.

But this CHECK was likely always wrong in the event that the sandbox
flags derive from the iframe's csp attribute. To add a bit more context
to this, we discussed this CHECK in the thread at
<a href="https://chromium-review.googlesource.com/c/chromium/src/+/3416475/8..15/content/browser/renderer_host/navigation_request.cc#2937.">https://chromium-review.googlesource.com/c/chromium/src/+/3416475/8..15/content/browser/renderer_host/navigation_request.cc#2937.</a>
The original motivation was to ensure that when navigating to about:
URLs, we wouldn't grab sandbox flags from
commit_params_-&gt;frame_policy.sandbox_flags in
NavigationRequest::GetUrlInfo() [1] but then end up committing with a
different set of sandbox flags that introduced the kOrigin restriction.
We didn't consider CSPEE (i.e., the iframe csp attribute), which
provides another way to introduce additional sandbox flags into the
final committed set, and which won't be in
commit_params_-&gt;frame_policy.sandbox_flags to start with.  So this
CHECK did its job and caught the condition we were worried about, since
we wouldn't honor the CSPEE sandbox flags for process isolation if we
were to proceed past the CHECK.

After this CL, the new HasComputedPolicies() check should ensure that we
grab the correct (final) sandbox flags in GetUrlInfo() even in the
about: case.  This is because when BeginNavigationImpl follows the
about: (!NeedsUrlLoader()) path, it already calls
SetupCSPEmbeddedEnforcement() [2] and then ComputePoliciesToCommit() [3]
to compute the final sandbox flags prior to calling
GetFrameHostForNavigation() [4], which will need the UrlInfo::is_sandboxed
bit to be correct.

[1] <a href="https://source.chromium.org/chromium/chromium/src/+/main:content/browser/renderer_host/navigation_request.cc;l=3155;drc=6b38b0a343702ddb553e99cef678b1d721fdd757">https://source.chromium.org/chromium/chromium/src/+/main:content/browser/renderer_host/navigation_request.cc;l=3155;drc=6b38b0a343702ddb553e99cef678b1d721fdd757</a>

[2] <a href="https://source.chromium.org/chromium/chromium/src/+/main:content/browser/renderer_host/navigation_request.cc;l=2106;drc=6b38b0a343702ddb553e99cef678b1d721fdd757">https://source.chromium.org/chromium/chromium/src/+/main:content/browser/renderer_host/navigation_request.cc;l=2106;drc=6b38b0a343702ddb553e99cef678b1d721fdd757</a>

[3] <a href="https://source.chromium.org/chromium/chromium/src/+/main:content/browser/renderer_host/navigation_request.cc;l=2128;drc=e724b5330b3c38c5051ac0ef18064778ea2830a3">https://source.chromium.org/chromium/chromium/src/+/main:content/browser/renderer_host/navigation_request.cc;l=2128;drc=e724b5330b3c38c5051ac0ef18064778ea2830a3</a>

[4] <a href="https://source.chromium.org/chromium/chromium/src/+/main:content/browser/renderer_host/navigation_request.cc;l=2161;drc=6b38b0a343702ddb553e99cef678b1d721fdd757.">https://source.chromium.org/chromium/chromium/src/+/main:content/browser/renderer_host/navigation_request.cc;l=2161;drc=6b38b0a343702ddb553e99cef678b1d721fdd757.</a>

This CL also modifies the code to take advantage of the flags in
`policy_container_navigation_bundle_` in navigation pathways that don't
go through NavigationRequest::OnResponseStarted, like the
BeginNavigation pathway used by srcdoc navigations. This will have the
effect of process isolating iframes that get their sandbox flags from
csp, and test coverage is added for this case.

Bug: 1319430
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I8c779f51f2480ec2abc44342284e040bfbfaf439">I8c779f51f2480ec2abc44342284e040bfbfaf439</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3614586">https://chromium-review.googlesource.com/c/chromium/src/+/3614586</a>
Commit-Queue: James Maclean &lt;wjmaclean@chromium.org&gt;
Reviewed-by: Alex Moshchuk &lt;alexmos@chromium.org&gt;
Reviewed-by: Arthur Sonzogni &lt;arthursonzogni@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#999519}
</pre>

</body>
</html>
