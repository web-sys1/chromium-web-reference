<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1006947/"> 1006947</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/cac6ddc491e2ca8ce89517e062dbff75d1e35106">cac6ddc491e2ca8ce89517e062dbff75d1e35106</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1006894/">1006894</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/c39b675180491a47d29f3e2244cac35f655bb14e">c39b675180491a47d29f3e2244cac35f655bb14e</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   cac6ddc491e2ca8ce89517e062dbff75d1e35106
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/cac6ddc491e2ca8ce89517e062dbff75d1e35106">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/cac6ddc491e2ca8ce89517e062dbff75d1e35106.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Fergal Daly &lt;fergal@chromium.org&gt;
  </td>
  <td>
   Tue May 24 17:42:03 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Tue May 24 17:42:03 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/cac6ddc491e2ca8ce89517e062dbff75d1e35106/">
    99428fba87c890f41bc1d29792e7a644ed77db9c
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/cac6ddc491e2ca8ce89517e062dbff75d1e35106%5E">
    068f68ba2f78ea8a044205ab0190f8a1abbf6de3
   </a>
   <span>
    [
    <a href="/chromium/src/+/cac6ddc491e2ca8ce89517e062dbff75d1e35106%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">Refactor vlog initialization to be more robust.

This fixes 2 problems.

1 Previously BaseInitLoggingImpl was written to allow it to be called twice but if called more than twice it would CHECK.

We hit this CHECK quite rarely but it does happen occasionally.

<a href="https://crash.corp.google.com/browse?q=product.name+IN+%28%22Chrome_Android%22%2C+%22Chrome%22%29+AND+expanded_custom_data.ChromeCrashProto.channel+IN+%28%27%27%29+AND+expanded_custom_data.ChromeCrashProto.magic_signature_1.name+LIKE+%27%25BaseInitLoggingImpl%25%27&amp;engine=dremel&amp;stbtiq=&amp;reportid=851e8a2a7b2c5ab7&amp;index=2#4">https://crash.corp.google.com/browse?q=product.name+IN+%28%22Chrome_Android%22%2C+%22Chrome%22%29+AND+expanded_custom_data.ChromeCrashProto.channel+IN+%28%27%27%29+AND+expanded_custom_data.ChromeCrashProto.magic_signature_1.name+LIKE+%27%25BaseInitLoggingImpl%25%27&amp;engine=dremel&amp;stbtiq=&amp;reportid=851e8a2a7b2c5ab7&amp;index=2#4</a>

The CHECK was added as part of the response to

<a href="https://code.google.com/archive/p/chromium-os/issues/20865">https://code.google.com/archive/p/chromium-os/issues/20865</a>

but is no needed.

2 g_vlog_info is written and read from multiple threads, this makes it thread unsafe and it seems like mostly coincidence the the updates stop quickly enough that that tests running under TSAN don't catch this.

----

This CL makes it possible to call BaseInitLoggingImpl multiple times. Instead of storing the old value, this uses leak-san annotations to make it clear that the leak is intentional.

Since g_vlog_info can be updated while other threads are reading from it, this also wraps it in std::atomic to make that safe.

All these changes also help with <a href="https://crrev.com/c/3648806.">https://crrev.com/c/3648806.</a>

Also add/update comments on #else and #endif.

The leak-detection CQ bot has been broken for months :(

# Cq-Include-Trybots: luci.chromium.try:leak_detection_linux


Bug: 1326416
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I3c7b08b3c166634c7f60a9cde788b4b41f60293f">I3c7b08b3c166634c7f60a9cde788b4b41f60293f</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3653381">https://chromium-review.googlesource.com/c/chromium/src/+/3653381</a>
Commit-Queue: Daniel Cheng &lt;dcheng@chromium.org&gt;
Reviewed-by: Daniel Cheng &lt;dcheng@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1006947}
</pre>

</body>
</html>
