<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/908136/"> 908136</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/5744c449f20e1e582dfb1bf2e7544f2c1cc4de8c">5744c449f20e1e582dfb1bf2e7544f2c1cc4de8c</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/908077/">908077</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/5ed3a6441ac08d0130111eea9604216e60ede777">5ed3a6441ac08d0130111eea9604216e60ede777</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   5744c449f20e1e582dfb1bf2e7544f2c1cc4de8c
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/5744c449f20e1e582dfb1bf2e7544f2c1cc4de8c">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/5744c449f20e1e582dfb1bf2e7544f2c1cc4de8c.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   manukh &lt;manukh@chromium.org&gt;
  </td>
  <td>
   Tue Aug 03 21:50:40 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Tue Aug 03 21:50:40 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/5744c449f20e1e582dfb1bf2e7544f2c1cc4de8c/">
    cc13b41fdf9458b12fe38b0ff0c162e99c5931e1
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/5744c449f20e1e582dfb1bf2e7544f2c1cc4de8c%5E">
    959a68bef02819318acf36c9a7f02e78633d7e37
   </a>
   <span>
    [
    <a href="/chromium/src/+/5744c449f20e1e582dfb1bf2e7544f2c1cc4de8c%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">[reland] [memories] Compute redirect-collapsed referral visits.

Reland of crrev.com/c/2971584, which was reverted with
crrev.com/c/3038488.

Navigations include redirects (e.g. <a href="http://google.com">http://google.com</a> can redirect to
<a href="https://www.google.com">https://www.google.com</a>) and referrals (e.g. clicking on links). All
redirects are referrals, but not vice versa.

All redirects and referrals are included in the visit database. UKM
seems to only track the first visit in a redirect chain, but I'll
further investigate this in a followup CL.

The history cluster tab helper is only notified of the last visit in a
redirect chain. Therefore, only the last visits' annotations are
calculated, persisted, and sent to the clustering model.

This leads to missing `referringVisitId` in the requests.

A common scenario:
  Navigate to google.com
    visit 1:                     <a href="http://google.com/">http://google.com/</a>
    visit 2 (redirected from 1): <a href="http://www.google.com/">http://www.google.com/</a>
    visit 3 (redirected from 2): <a href="https://www.google.com/">https://www.google.com/</a>
    visit 4:                     <a href="https://www.google.com/">https://www.google.com/</a>
  Search
    visit 5 (referred from 4):   <a href="https://www.google.com/?query...">https://www.google.com/?query...</a>
    visit 6 (referred from 5):   <a href="https://www.google.com/?query...">https://www.google.com/?query...</a>
  Follow link
    visit 7 (referred from 6):   <a href="https://en.wikipedia.org">https://en.wikipedia.org</a>
    visit 8 (redirected from 7): <a href="https://en.wikipedia.org/wiki/Main_Page">https://en.wikipedia.org/wiki/Main_Page</a>
Note, visit 4 is neither a redirect nor referral, but it occurs
automatically; i.e. it looks like a redirect to the user.

In this case, we have 2 redirect chains: 1-&gt;2-&gt;3 and 7-&gt;8. So the
request will exclude visits 1, 2, and 7, yet visit 3 will have
`referringVisitId` 2, and likewise visit 8 will have `referringVisitId`
7. The request will look like:
  [
    { visitId: 3, referringVisitId: 2},
    { visitId: 4, referringVisitId: 0},
    { visitId: 5, referringVisitId: 4},
    { visitId: 6, referringVisitId: 5},
    { visitId: 8, referringVisitId: 7},
  ]

With this CL, the request's `referringVisitId`s are set to the
`referring_visit`s of the 1st visit in each visit's redirect chain. So
visit 3 will inherit visit 1's referral, and visit 8 will inherit visit
7's referral.

E.g., in the above case, the request will look like:
  [
    { visitId: 3, referringVisitId: 0}, // redirect chain: 1-&gt;2-&gt;3
    { visitId: 4, referringVisitId: 0},
    { visitId: 5, referringVisitId: 4},
    { visitId: 6, referringVisitId: 5},
    { visitId: 8, referringVisitId: 6}, // redirect chain: 7-&gt;8
  ]

Bug: 1220154, 1184879, 1171352
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I8b16efd5fc0bc3a762d96b37c45dcf5df50be46a">I8b16efd5fc0bc3a762d96b37c45dcf5df50be46a</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3063164">https://chromium-review.googlesource.com/c/chromium/src/+/3063164</a>
Commit-Queue: manuk hovanesian &lt;manukh@chromium.org&gt;
Reviewed-by: Tommy Li &lt;tommycli@chromium.org&gt;
Reviewed-by: Ted Choc &lt;tedchoc@chromium.org&gt;
Cr-Commit-Position: refs/heads/master@{#908136}
</pre>

</body>
</html>
