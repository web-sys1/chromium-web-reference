<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/862960/"> 862960</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/6a7ba438e45695ecf6e943914cbb410103762f1b">6a7ba438e45695ecf6e943914cbb410103762f1b</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/862937/">862937</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/dc2ceaa49bbd95460b53361f0052bb98da49aadf">dc2ceaa49bbd95460b53361f0052bb98da49aadf</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   6a7ba438e45695ecf6e943914cbb410103762f1b
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/6a7ba438e45695ecf6e943914cbb410103762f1b">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/6a7ba438e45695ecf6e943914cbb410103762f1b.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Victor Hugo Vianna Silva &lt;victorvianna@google.com&gt;
  </td>
  <td>
   Mon Mar 15 21:15:46 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Mon Mar 15 21:15:46 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/6a7ba438e45695ecf6e943914cbb410103762f1b/">
    185c171246ec6beebd9cbfdfa916a2c8f744f81c
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/6a7ba438e45695ecf6e943914cbb410103762f1b%5E">
    d3b13861bc3bdb32c0ae580023cee99fca335654
   </a>
   <span>
    [
    <a href="/chromium/src/+/6a7ba438e45695ecf6e943914cbb410103762f1b%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">[sync] Make Cryptographer more singleton-like

Before this CL, ModelTypeRegistry and ModelTypeWorker would successively
store snapshots of the latest version of the cryptographer (copies). In
reality, there's one true cryptographer owned by NigoriState. So, with
this CL:

1) There are no more copies, ModelTypeWorker-s and ModelTypeRegistry
keep a reference to the same constant cryptographer.

2) SyncEncryptionHandler now exposes a getter for the one cryptographer.
This gives ModelTypeRegistry immediate access to it, avoiding some weird
DCHECKs ("don't try to encrypt data before the cryptographer arrives").
This is one step to fix a broader problem with SyncEncryptionHandler:
its Observer-s are notified of changes to some state (e.g.
PassphraseType) but this state is never exposed in the interface. Future
CLs will add similar getters for the rest of the state, unblocking
further simplifications.

3) ModelTypeWorker continues to have the same setup Cryptographer-wise,
i.e. it has a cryptographer iff the data type is encrypted. However, the
obsolete UpdateCryptographer(std::unique_ptr&lt;Cryptographer&gt;) is split in
2 parts:
    Notification - OnCryptographerChange(): reacts to cryptography
    changes as before. For instance, it attempts to decrypt pending
    data if more encryption keys are now available.
    Initialization - InitCryptographer(Cryptographer*): performs late
    initialization of the cryptographer for a type that transitioned
    from non-encrypted to encrypted. Internally calls
    OnCryptographerChange().
There's a subtle change in how often these codepaths are triggered in
ModelTypeRegistry::OnEncryptedTypesChanged(). The change does *not*
cause observable behavioral differences. Before this CL, every
[enabled] type in the new "encrypted types" set used to get a
notification. But OnEncryptedTypesChanged() isn't about changes to the
cryptographer state, so there was no reason to notify types that
already had a cryptographer. In this CL, we simply call
InitCryptographer() for the set of types that just became encrypted,
which leads to simpler code. Note that OnCryptographerChange() is
still internally called to make sure the worker actually uses the new
cryptographer.

Finally:
One interesting caveat is that there used to be one case where Sync had
no cryptographer. This happened if the local nigori state was corrupted,
see this return nullptr [1]. However, this case was never actually
handled and caused a seg fault. The new code will always have a
cryptographer, but will CHECK() for corruption of the local state,
preventing regressions.

[1] <a href="https://source.chromium.org/chromium/chromium/src/+/cbf394c0867c2570d39bbecc8c9751c14a97fce3:components/sync/nigori/cryptographer_impl.cc;l=40;bpv=1;bpt=1">https://source.chromium.org/chromium/chromium/src/+/cbf394c0867c2570d39bbecc8c9751c14a97fce3:components/sync/nigori/cryptographer_impl.cc;l=40;bpv=1;bpt=1</a>
[2] <a href="https://source.chromium.org/chromium/chromium/src/+/cbf394c0867c2570d39bbecc8c9751c14a97fce3:components/sync/nigori/cryptographer_impl.cc;l=51;bpv=1;bpt=1">https://source.chromium.org/chromium/chromium/src/+/cbf394c0867c2570d39bbecc8c9751c14a97fce3:components/sync/nigori/cryptographer_impl.cc;l=51;bpv=1;bpt=1</a>

Bug: 1109221, 1178418
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I317707edc126b4dc2722bc0d2b2cecbcd94e7b19">I317707edc126b4dc2722bc0d2b2cecbcd94e7b19</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/2732148">https://chromium-review.googlesource.com/c/chromium/src/+/2732148</a>
Commit-Queue: Victor Vianna &lt;victorvianna@google.com&gt;
Reviewed-by: Mikel Astiz &lt;mastiz@chromium.org&gt;
Cr-Commit-Position: refs/heads/master@{#862960}
</pre>

</body>
</html>
