<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/966490/"> 966490</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/f507c5362a3058955d21775ae039fbcbd8d69793">f507c5362a3058955d21775ae039fbcbd8d69793</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/966490/">966490</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/f507c5362a3058955d21775ae039fbcbd8d69793">f507c5362a3058955d21775ae039fbcbd8d69793</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   f507c5362a3058955d21775ae039fbcbd8d69793
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/f507c5362a3058955d21775ae039fbcbd8d69793">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/f507c5362a3058955d21775ae039fbcbd8d69793.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Austin Orion &lt;auorion@microsoft.com&gt;
  </td>
  <td>
   Thu Feb 03 01:51:01 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Thu Feb 03 01:51:01 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/f507c5362a3058955d21775ae039fbcbd8d69793/">
    7e155aeab1a56eedfd648aa6e757682531016922
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/f507c5362a3058955d21775ae039fbcbd8d69793%5E">
    1e63217d7bc9e404459124a5f6c5d7312f9452de
   </a>
   <span>
    [
    <a href="/chromium/src/+/f507c5362a3058955d21775ae039fbcbd8d69793%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">Avoid deadlock when enumerating current process windows for capture.

Enumerating windows owned by the current process on Windows has some
complications. The GetWindowText*() APIs may cause a deadlock because
they send messages to the window's message loop, and if the message loop
is waiting on the operation we will enter a deadlock.

This happens occasionally in Chromium when a user closes the
capture picker window. That sends a message to the main window which
leads to the destruction of the NativeDesktopMediaList object. In its
destructor it tries to stop a worker thread that is responsible for
capturing the windows, but that worker thread is waiting on the main
thread to respond to a WM_GETTEXT message with the window title. The
thread can't join and thus we enter a deadlock.

To avoid this issue I added a new DesktopCaptureOption to WebRTC that
causes |GetSourceList()| to ignore windows owned by the current
process. This prevents the worker thread from ever waiting on
Chromium's main thread, preventing the deadlock scenario. This CL opts
in to that new behavior by setting the
enumerate_current_process_windows option to false.

This means we have to find all the windows owned by the current
process and add them to the list ourselves, including their titles.
We achieve this by storing the title as a member in
DesktopWindowTreeHostWin, which is responsible for setting the
window's title already. This way we can get the title without
having to send a WM_GETTEXT message.

Here is a link to the WebRTC CL that added the option:
<a href="https://webrtc-review.googlesource.com/c/src/+/219380">https://webrtc-review.googlesource.com/c/src/+/219380</a>

Bug: 1152841
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I39d8cc2aa6c0a2c3e505e16c744ffdf16ba3d5c7">I39d8cc2aa6c0a2c3e505e16c744ffdf16ba3d5c7</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/2907415">https://chromium-review.googlesource.com/c/chromium/src/+/2907415</a>
Reviewed-by: Camille Lamy &lt;clamy@chromium.org&gt;
Reviewed-by: Robert Liao &lt;robliao@chromium.org&gt;
Reviewed-by: Elad Alon &lt;eladalon@chromium.org&gt;
Commit-Queue: Austin Orion &lt;auorion@microsoft.com&gt;
Cr-Commit-Position: refs/heads/main@{#966490}
</pre>

</body>
</html>
