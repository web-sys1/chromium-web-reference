<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1120732/"> 1120732</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/c07af75cdb431e134f7c030addcb919f8400db14">c07af75cdb431e134f7c030addcb919f8400db14</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1120707/">1120707</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/2fbbadcaf07ec1334166530627c4fe3289b32d08">2fbbadcaf07ec1334166530627c4fe3289b32d08</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   c07af75cdb431e134f7c030addcb919f8400db14
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/c07af75cdb431e134f7c030addcb919f8400db14">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/c07af75cdb431e134f7c030addcb919f8400db14.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Devlin Cronin &lt;rdevlin.cronin@chromium.org&gt;
  </td>
  <td>
   Wed Mar 22 19:50:15 2023
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Wed Mar 22 19:50:15 2023
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/c07af75cdb431e134f7c030addcb919f8400db14/">
    4347d2eaa7ac7950bf43f1a82ca5b14d90720b78
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/c07af75cdb431e134f7c030addcb919f8400db14%5E">
    e7b221f562af74be899e8c411e6ced317d1046bc
   </a>
   <span>
    [
    <a href="/chromium/src/+/c07af75cdb431e134f7c030addcb919f8400db14%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">[Reland][Extensions] Don't allow unregistration of extension service workers

This is a reland of
<a href="https://chromium-review.googlesource.com/c/chromium/src/+/4257067.">https://chromium-review.googlesource.com/c/chromium/src/+/4257067.</a>

--- Reland Notes ---
The original version caused the browser test
ServiceWorkerTestWithEarlyReadyMesssage.MissingRegistrationMitigated to
be flaky.

This wasn't entirely unexpected, since that CL relies on removing the
SW registration, which this CL (intentionally) makes more difficult. In
testing, the previous approach (immediately trying to remove the
registration) consistently worked, but it seems it was not quite
robust enough.

Instead, add a test method to temporarily allow unregistering certain
extension service workers.

--- Original Description ---

If an extension is service worker-based, the registration of its
root-scope service worker (the extension's primary service worker) is
critical to the extension's functionality; removing it results in the
extension being in a broken state. Given this, we should not allow the
unregistration of this service worker through "normal" means (such as
the browsingData API). The extension service worker's registration
should instead be tied to the extension's enabled state (registered
as long as the extension is enabled). If a user or other party wants
to unregister this worker, they should disable or remove the extension.

This CL introduces a new method on ContentBrowserClient,
`MayDeleteServiceWorkerRegistration()`, which allows embedders to
indicate that a service worker registration cannot be deleted. Check
this prior to deleting a service worker, and disallow deletion of any
root-scope service workers associated with enabld service worker-based
extensions.

Add tests to cover both an example case that should now be impossible
(deleting an extension service worker through the browsingData API), as
well as other scenarios that should keep working (like updating and
removing the extension) to ensure these flows are properly handled (and
do allow deletion of the service worker).

Known limitation: the button for "Unregister" in
chrome://serviceworker-internals is still visible, but clicking it
does nothing (but also, doesn't crash). A followup will remove the
button from the UI.

Bug: 1392498
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/Ife518812a8d9e2847d51a267724b2a0f7674e337">Ife518812a8d9e2847d51a267724b2a0f7674e337</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/4354471">https://chromium-review.googlesource.com/c/chromium/src/+/4354471</a>
Reviewed-by: David Bertoni &lt;dbertoni@chromium.org&gt;
Reviewed-by: Alex Moshchuk &lt;alexmos@chromium.org&gt;
Commit-Queue: Devlin Cronin &lt;rdevlin.cronin@chromium.org&gt;
Reviewed-by: Yoshisato Yanagisawa &lt;yyanagisawa@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1120732}
</pre>

</body>
</html>
