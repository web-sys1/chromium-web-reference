<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/975044/"> 975044</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/d0bd04040b4e6137dce4a9a161bb25ad40121006">d0bd04040b4e6137dce4a9a161bb25ad40121006</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/975043/">975043</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/f750d4106a78027b00e06d656b1a4be4a1662a9a">f750d4106a78027b00e06d656b1a4be4a1662a9a</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   d0bd04040b4e6137dce4a9a161bb25ad40121006
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/d0bd04040b4e6137dce4a9a161bb25ad40121006">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/d0bd04040b4e6137dce4a9a161bb25ad40121006.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Piotr Tworek &lt;ptworek@vewd.com&gt;
  </td>
  <td>
   Fri Feb 25 08:37:01 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Fri Feb 25 08:37:01 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/d0bd04040b4e6137dce4a9a161bb25ad40121006/">
    95d2404ec8bc30fd17665d57de23e5764618b8af
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/d0bd04040b4e6137dce4a9a161bb25ad40121006%5E">
    f750d4106a78027b00e06d656b1a4be4a1662a9a
   </a>
   <span>
    [
    <a href="/chromium/src/+/d0bd04040b4e6137dce4a9a161bb25ad40121006%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">Don't call FetchDataLoader::Client methods after ::Cancel.

According to documentation from fetch_data_loader.h:

  If FetchDataLoader::Cancel() is called, Client's methods will not be
  called anymore.

This statement seems to be false for FetchDataLoaderAsBlobHandle. There
seems to be at least one case where blink::BodyStreamBuffer::StopLoading
calls FetchDataLoader::Cancel, but the
BodyStreamBuffer::LoaderClient::DidFetchDataLoadedBlobHandle can still
get called afterwards.

When this happens the Cancel call is issued from:

* blink::BodyStreamBuffer::StopLoading()
* blink::ContextLifecycleObserver::NotifyContextDestroyed()
* blink::ContextLifecycleNotifier::NotifyContextDestroyed()
* blink::LocalDOMWindow::FrameDestroyed()
* blink::LocalDOMWindow::Reset()
* blink::LocalFrame::SetDOMWindow()
* blink::DocumentLoader::InitializeWindow()
* blink::DocumentLoader::CommitNavigation()
* blink::FrameLoader::CommitDocumentLoader()
* blink::FrameLoader::CommitNavigation()
* blink::WebLocalFrameImpl::CommitNavigation()
* content::RenderFrameImpl::CommitNavigationWithParams()
* base::internal::FunctorTraits&lt;&gt;::Invoke&lt;&gt;()

Then a bit later DidFetchDataLoaderBlobHandle can sometimes get called
from:

* blink::BodyStreamBuffer::EndLoading()
* blink::BodyStreamBuffer::LoaderClient::DidFetchDataLoadedBlobHandle()
* blink::(anonymous namespace)::FetchDataLoaderAsBlobHandle::FinishedCreatingFromDataPipe()
* _ZNO4base12OnceCallbackIFvN3omi4impl13ResultBuilderINS1_3msg10MouseInputEEEEE3RunES6_
* WTF::ThreadCheckingCallbackWrapper&lt;&gt;::Run()
* _ZNO4base12OnceCallbackIFvN3omi4impl13ResultBuilderINS1_3msg10MouseInputEEEEE3RunES6_
* blink::mojom::blink::BlobRegistry_RegisterFromStream_ForwardToCallback::Accept()
* mojo::InterfaceEndpointClient::HandleValidatedMessage()

When this happens the DCHECK(loader_) in EndLoading will fail since the
loader_ pointer has been set to nullptr in the preceding call to
StopLoading.

The issue is not 100% reproducible, there is certainly timing factor
involved, but I can trigger it quite reliably by manually reloading
certain internal, heavy page while its loading. It can also be triggered
by the included unit test, provided the remaining part of the patch gets
reverted.

This patch makes sure FetchDataLoaderAsBlobHandle won't invoke any
client methods after its Cancel method has been called.

Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I898321b2a87b4a650458b5befbbc46ec8f1ff034">I898321b2a87b4a650458b5befbbc46ec8f1ff034</a>
Bug: 1300791
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3488186">https://chromium-review.googlesource.com/c/chromium/src/+/3488186</a>
Commit-Queue: Piotr Tworek &lt;ptworek@vewd.com&gt;
Auto-Submit: Piotr Tworek &lt;ptworek@vewd.com&gt;
Reviewed-by: Yutaka Hirano &lt;yhirano@chromium.org&gt;
Commit-Queue: Yutaka Hirano &lt;yhirano@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#975044}
</pre>

</body>
</html>
