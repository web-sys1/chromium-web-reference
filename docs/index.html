<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/859297/"> 859297</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/d2faae6ee86fe8763382ca007824c4d48016efd0">d2faae6ee86fe8763382ca007824c4d48016efd0</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/859305/">859305</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/d8899487fca4b4ffa26097d5ba6bea071101b6c3">d8899487fca4b4ffa26097d5ba6bea071101b6c3</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   d2faae6ee86fe8763382ca007824c4d48016efd0
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/d2faae6ee86fe8763382ca007824c4d48016efd0">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/d2faae6ee86fe8763382ca007824c4d48016efd0.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Colin Blundell &lt;blundell@chromium.org&gt;
  </td>
  <td>
   Wed Mar 03 08:53:45 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Wed Mar 03 08:53:45 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/d2faae6ee86fe8763382ca007824c4d48016efd0/">
    797b823899fc84068457e36502a8c47e035f96c5
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/d2faae6ee86fe8763382ca007824c4d48016efd0%5E">
    d7ae4173ebe1a792a41f879e62e702a12cdedf01
   </a>
   <span>
    [
    <a href="/chromium/src/+/d2faae6ee86fe8763382ca007824c4d48016efd0%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">[WebLayer] Eliminate flake in subresource filter browsertests

//weblayer's subresource filter browsertests were subject to flake that
showed up only on Win7. I have finally found the cause:
- In these test flows, they create test ruleset data and inject that
  data via RulesetService, listening for a "ruleset was published"
  callback before proceeding with the test.
- However, unlike Chrome, WebLayer indexes and publishes the ruleset
  from disk as part of startup.
- These browsertests were not waiting for that initial publishing to be
  complete before starting their test flows.
- Thus, it was possible that the initial publishing was still in process
  when the test started listening for the "ruleset was published"
  callback. This callback then got triggered for the completion of the
  *initial* publishing, at which point the test proceeded with the
  production data installed rather than the test data (the test data got
  installed at some random later point).

D'oh! Note that there is nothing Windows-specific about this race; it
must just be a fruitful environment for tickling it.

This CL changes //weblayer's SubresourceFilterBrowsertest to wait for
the initial ruleset data to be published in SetUpOnMainThread() and
re-enables the tests on Win7. On swarming the test suite passes a
set of 100 runs with the fix (without the fix the flakes already show
in a set of 10 runs).

Bug: 1116095, 1152429
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I76f90c2af7bb400113fb9fc14312f0499a3d005f">I76f90c2af7bb400113fb9fc14312f0499a3d005f</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/2727329">https://chromium-review.googlesource.com/c/chromium/src/+/2727329</a>
Reviewed-by: Charlie Harrison &lt;csharrison@chromium.org&gt;
Commit-Queue: Colin Blundell &lt;blundell@chromium.org&gt;
Cr-Commit-Position: refs/heads/master@{#859297}
</pre>

</body>
</html>
