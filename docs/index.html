<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/905250/"> 905250</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/e70025cc10978ff62367aa36f2217d760e360749">e70025cc10978ff62367aa36f2217d760e360749</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/905237/">905237</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/f750ab2a50fac458ca3034b1c0fa50699cff72d4">f750ab2a50fac458ca3034b1c0fa50699cff72d4</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   e70025cc10978ff62367aa36f2217d760e360749
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/e70025cc10978ff62367aa36f2217d760e360749">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/e70025cc10978ff62367aa36f2217d760e360749.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Ian Vollick &lt;vollick@chromium.org&gt;
  </td>
  <td>
   Mon Jul 26 14:56:29 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Mon Jul 26 14:56:29 2021
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/e70025cc10978ff62367aa36f2217d760e360749/">
    f74828a3f03c13f43d5ad8deb70ae9d9d1bbd79f
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/e70025cc10978ff62367aa36f2217d760e360749%5E">
    1cb4c86ab138313ad1058ecf3dde95f6375d1dd6
   </a>
   <span>
    [
    <a href="/chromium/src/+/e70025cc10978ff62367aa36f2217d760e360749%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">Defer password management / autofill until activation

Defers sending messages from the render to ContentAutofillDriver
and ContentPasswordManagerDriver until activation. I have also added
corresponding browser-side checks to ensure that we don't receive
unexpected messages from a renderer while it's prerendering (we tear
down the renderer in this case).

This should have no effect beyond prerendering.

Although it would have been desirable to defer calls to the agents,
I think there are some drawbacks to this approach
 - There are a number of ways blink can interact with the agents (eg
   RenderFrameObserver, FormTracker::Observer, WebAutofillClient) and
   it's both possible that this current list is incomplete and that new
   code gets introduced in future that should be deferred, but isn't.
   I think the mojo interface is a clearly demarcated point of deferral
   and consequently more likely to be correct, presently, and less
   likely to break in future.
 - Some calls take references to WebElements and retaining them could,
   I think, transitively keep a far bit of DOM alive if pages are large
   and churning during prerendering.
For these reasons, I've deferred at the mojo level, simulating a slow
browser process. This also aligns with the approach we're taking for
mojo capability control for other features. We cannot take that approach
directly since we're using channel associated interfaces, but we would
similarly keep the renderer side code (apart from the mojo interface
calls) ignorant of prerendering and could easily convert to mojo
capability control if we move away from channel associated interfaces.

The deferral was accomplished by creating "deferring" flavors of the
mojo interfaces. This results in a fair bit of boilerplate. It seems
like this is something that could be autogenerated, but I'm not sure
it would be used widely enough to warrant the complexity of teaching
mojo how to do this.

Another means of deferring would have been to make these interfaces
non-associated and then hooking them up, post-activation as we do for
other features while prerendering, but this could reintroduce
crbug.com/866616. To minimize risk, I've taken the current approach
rather than switching back to non-associated interfaces and trying to
fix the ordering/lifetime issues in another way.

Since these deferred messages should not be sent if the prerender is
cancelled, I don't think this deferral will cause the same issues.

In order to test this, mocks needed to be dynamically injected for the
prerendered frame. This happened to address crbug.com/1119526. The
tests do a spot check on interfaces to check that a few messages are
correctly deferred/re-sent -- they are not exhaustive.

Also, thanks to altimin@ for helping address issues with the binding
of the templated variadic function in the Deferring drivers, and thanks
to mcnee@ for pointing out the need for PRESUBMIT.py.

Bug: 1119526,1222780
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I131115e646c7ee5d896be8d00744a4300e81438a">I131115e646c7ee5d896be8d00744a4300e81438a</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/2970765">https://chromium-review.googlesource.com/c/chromium/src/+/2970765</a>
Commit-Queue: Ian Vollick &lt;vollick@chromium.org&gt;
Reviewed-by: Steven Holte &lt;holte@chromium.org&gt;
Reviewed-by: Christoph Schwering &lt;schwering@google.com&gt;
Reviewed-by: Lucas Gadani &lt;lfg@chromium.org&gt;
Reviewed-by: Vasilii Sukhanov &lt;vasilii@chromium.org&gt;
Cr-Commit-Position: refs/heads/master@{#905250}
</pre>

</body>
</html>
