<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1108360/"> 1108360</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/cab67d06307ebbd3954413dd887df893a9f59ba9">cab67d06307ebbd3954413dd887df893a9f59ba9</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1108316/">1108316</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/065085a2136b00a0722c89f52f375b0c4014f91d">065085a2136b00a0722c89f52f375b0c4014f91d</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   cab67d06307ebbd3954413dd887df893a9f59ba9
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/cab67d06307ebbd3954413dd887df893a9f59ba9">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/cab67d06307ebbd3954413dd887df893a9f59ba9.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Xiaohan Wang &lt;xhwang@chromium.org&gt;
  </td>
  <td>
   Wed Feb 22 16:05:01 2023
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Wed Feb 22 16:05:01 2023
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/cab67d06307ebbd3954413dd887df893a9f59ba9/">
    ce16baef277422abb0e96dcecd8f9f7013dacca5
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/cab67d06307ebbd3954413dd887df893a9f59ba9%5E">
    aafe42bb26fc3a60b7b77c92d20f0dc2b9ff388a
   </a>
   <span>
    [
    <a href="/chromium/src/+/cab67d06307ebbd3954413dd887df893a9f59ba9%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">media: Add CdmEvent::kHardwareContextReset

HardwareContextReset is supposed to happens during suspend/resume or
GPU swap, which should NOT be treated as an error. Therefore, it's not
included in the hardware secure decryption fallback logic.

However, we suspect that HardwareContextReset could happen without any
suspend/resume or GPU swap. One of the symptoms is that
HardwareContextReset happens on the first session creation or generate
request, or without any playback.

This CL makes the change that HardwareContextReset without any power
or display change will be reported to MediaFoundationServiceMonitor
and be included in the hardware secure decryption fallback logic.
This is controlled under a feature param which is default to true.
We can disable this feature if the assumption is wrong and we ended up
disabling a lot of users. We may also run an experiment to see how it
works.

Manually tested by following these steps:
1.  Launch chrome with
    `--enable-features=HardwareSecureDecryptionFallback:on_hardware_context_reset/true`
1a. Force HardwareContextReset in MediaFoundationCdm when updating
    the session, and after a few playback attempts, hardware secure
    decryption is disabled due to the fallback logic.
1b. Sleep the device during playback and notice a playback error with
    DRM_E_TEE_INVALID_HWDRM_STATE. This is ignored since it's after
    a power change and therefore does not disable hardware secure
    decryption.
2.  Launch chrome with
    `--enable-features=HardwareSecureDecryptionFallback:on_hardware_context_reset/false`
    Repeat 1a and 1b and hardware secure decryption is never disabled.

Bug: 1370844
Test: Updated unit tests. See above for manual tests done.
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/Iabd4a4516ad9e66e5346a8fc3c762764b7ede1c1">Iabd4a4516ad9e66e5346a8fc3c762764b7ede1c1</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/4015369">https://chromium-review.googlesource.com/c/chromium/src/+/4015369</a>
Auto-Submit: Xiaohan Wang &lt;xhwang@chromium.org&gt;
Commit-Queue: Xiaohan Wang &lt;xhwang@chromium.org&gt;
Reviewed-by: Emily Stark &lt;estark@chromium.org&gt;
Reviewed-by: Frank Li &lt;frankli@microsoft.com&gt;
Reviewed-by: John Rummell &lt;jrummell@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1108360}
</pre>

</body>
</html>
