<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<base href="https://chromium.googlesource.com/">
<style type="text/css">
table.blueTable {
  border: 1px solid #1C6EA4;
  background-color: #EEEEEE;
  width: 100%;
  text-align: center;
  border-collapse: collapse;
}
table.blueTable td, table.blueTable th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
table.blueTable tbody td {
  font-size: 16px;
}
table.blueTable tr:nth-child(even) {
  background: #D0E4F5;
}
table.blueTable thead {
  background: #3077A4;
  background: -moz-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: -webkit-linear-gradient(top, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  background: linear-gradient(to bottom, #6499bb 0%, #4484ad 66%, #3077A4 100%);
  border-bottom: 2px solid #444444;
}
table.blueTable thead th {
  font-size: 15px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #D0E4F5;
}
table.blueTable thead th:first-child {
  border-left: none;
}
table.blueTable tfoot {
  font-size: 8px;
  font-weight: bold;
  color: #FFFFFF;
  background: #D0E4F5;
  background: -moz-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: -webkit-linear-gradient(top, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  background: linear-gradient(to bottom, #dcebf7 0%, #d4e6f6 66%, #D0E4F5 100%);
  border-top: 2px solid #444444;
}
table.blueTable tfoot td {
  font-size: 8px;
}
table.blueTable tfoot .links {
  text-align: right;
}
table.blueTable tfoot .links a{
  display: inline-block;
  background: #1C6EA4;
  color: #FFFFFF;
  padding: 2px 8px;
  border-radius: 5px;
}
body{
    background: #fff2e0;
}
.Metadata {
    margin-bottom: 15px;
}
.u-monospace {
    font-family: 'Source Code Pro',monospace;
    max-width: 100%;
    overflow-x: scroll;
    border: groove #c33b3b 2px;
}
.MetadataMessage {
    background-color: #b9caff;
    border: 1px solid #de5353;
    color: #000;
    margin: 0;
    padding: 12px;
    white-space: pre-wrap;
}
</style>
</head>
<body>

    <table class="blueTable">
     <thead>
      <tr>
       <th><strong>REVISION ID</strong></th>
       <th>SHA-1 COMMIT</th>
      </tr>
    </thead>
    <tfoot></tfoot>
     <tbody>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Mac/1038255/"> 1038255</a> <sup><b>(MAC)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/3cc95c574182aa1b2e9198079dd9809b6b3eb327">3cc95c574182aa1b2e9198079dd9809b6b3eb327</a></td>
      </tr>
      <tr>
       <td><a href ="https://commondatastorage.googleapis.com/chromium-browser-snapshots/index.html?prefix=Win/1038234/">1038234</a> <sup><b>(WIN)</b></sup></td>
       <td><a href="https://chromium.googlesource.com/chromium/src/+/58d6ebc349a9dda55ee40a586fff6983271d5fb9">58d6ebc349a9dda55ee40a586fff6983271d5fb9</a></td>
     </tbody>
    </table>
   <hr><table>
 <tr>
  <th class="Metadata-title">
   commit
  </th>
  <td>
   3cc95c574182aa1b2e9198079dd9809b6b3eb327
  </td>
  <td>
   <span>
    [
    <a href="/chromium/src/+log/3cc95c574182aa1b2e9198079dd9809b6b3eb327">
     log
    </a>
    ]
   </span>
   <span>
    [
    <a href="/chromium/src/+archive/3cc95c574182aa1b2e9198079dd9809b6b3eb327.tar.gz">
     tgz
    </a>
    ]
   </span>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   author
  </th>
  <td>
   Tsuyoshi Horo &lt;horo@chromium.org&gt;
  </td>
  <td>
   Tue Aug 23 15:43:53 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   committer
  </th>
  <td>
   Chromium LUCI CQ &lt;chromium-scoped@luci-project-accounts.iam.gserviceaccount.com&gt;
  </td>
  <td>
   Tue Aug 23 15:43:53 2022
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   tree
  </th>
  <td>
   <a href="/chromium/src/+/3cc95c574182aa1b2e9198079dd9809b6b3eb327/">
    1b69124c5cdb765846424ddbb074ae3e14162970
   </a>
  </td>
 </tr>
 <tr>
  <th class="Metadata-title">
   parent
  </th>
  <td>
   <a href="/chromium/src/+/3cc95c574182aa1b2e9198079dd9809b6b3eb327%5E">
    850c4a3af29c4bcc8f9f58f25469e870c401000d
   </a>
   <span>
    [
    <a href="/chromium/src/+/3cc95c574182aa1b2e9198079dd9809b6b3eb327%5E%21/">
     diff
    </a>
    ]
   </span>
  </td>
 </tr>
</table><hr style="height:1px;border-width:0;color:gray;background-color:gray"><pre class="u-pre u-monospace MetadataMessage">Fix use-of-uninitialized-value bug in DnsAttempt

There are three sub classes of DnsAttempt.
 1. DnsUDPAttempt
 2. DnsHTTPAttempt
 3. DnsTCPAttempt

All sub classes have use-of-uninitialized-value bug in
GetRawResponseBufferForLog() method which is called when Netlog with
"Include raw bytes" is enabled.

1. DnsUDPAttempt's response_ is initialized with (kMaxUDPSize + 1) size
   buffer. And the buffer will be written with the UDP response bytes by
   socket_-&gt;Read() call in DoReadResponse(). The remaining buffer is not
   initialized, and GetRawResponseBufferForLog() will access the
   uninitialized area.

2. DnsHTTPAttempt reads the response body to a GrowableIOBuffer buffer_.
   And response_ is initialized with buffer_ and the size is set to (the
   offset of buffer_ + 1). The last one byte is not initialized, and
   GetRawResponseBufferForLog() will access the uninitialized last byte.

3. DnsTCPAttempt reads the first sizeof(uint16_t) bytes of the response
   to length_buffer_, and gets the remaining response length from the
   length_buffer_. And initializes response_ with (the remaining
   response length + 1) size buffer. And read the remaining response to
   the buffer. So the last one byte is not initialized, and
   GetRawResponseBufferForLog() will access the uninitialized last byte.


To fix this, this CL changes as followings:

1. DnsUDPAttempt will keep the written byte size in read_size_, and
   GetRawResponseBufferForLog() will only returns the written area.

2. 3. DnsHTTPAttempt and DnsTCPAttempt will initialize response_ with
   the necessary size without + 1. We have been allocating the more one
   byte space. It is because when <a href="https://crrev.com/174227">https://crrev.com/174227</a> introduced
   DnsTCPAttempt, DnsResponse::InitParse() was checking the buffer size
   with greater or equal `&gt;=`:
   if (... || nbytes &gt;= io_buffer_-&gt;size()) {
     return false;
   }
   So we needed one more byte space to pass the sanity check. But this
   was misguided. We can use greater `&gt;` for checking the buffer size.
   <a href="https://crrev.com/665935">https://crrev.com/665935</a> changed DnsResponse::InitParse() to
   use greater `&gt;`. So now we don't need to allocate the more one byte
   anymore.

This CL adds following tests in dns_transaction_unittest.cc,
 - DnsTransactionTest.LookupWithLog
 - DnsTransactionTest.TcpLookup_UdpRetry_WithLog
and re-enables DnsTransactionTest.HttpsPostLookupWithLog.

Bug: 1245953
Change-Id: <a href="https://chromium-review.googlesource.com/#/q/I7b827abaa1a2fc4ba7585b025189476f708fb13b">I7b827abaa1a2fc4ba7585b025189476f708fb13b</a>
Reviewed-on: <a href="https://chromium-review.googlesource.com/c/chromium/src/+/3849096">https://chromium-review.googlesource.com/c/chromium/src/+/3849096</a>
Reviewed-by: Dan McArdle &lt;dmcardle@chromium.org&gt;
Commit-Queue: Tsuyoshi Horo &lt;horo@chromium.org&gt;
Cr-Commit-Position: refs/heads/main@{#1038255}
</pre>

</body>
</html>
